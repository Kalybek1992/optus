{% extends './Navbar/Navbar.twig' %}

{% block content %}

    {% include './Breadcrumb/DistributionCommodityMoney.twig' %}

    <div class="w-full max-w-5xl mx-auto px-4 pb-96 my-8">
        <ul class="list bg-base-100 rounded-lg shadow-md space-y-4">
            <li class="relative p-4 bg-base-200 rounded-lg border border-gray-300">
                <!-- Указать сумму  -->
                <div x-data="{
                        total: {{ stock_balances }},
                        entered: '',
                        get status() {
                            if (!this.entered || isNaN(this.entered) || Number(this.entered) <= 0) return 'invalid';
                            if (Number(this.entered) > this.total) return 'exceed';
                            return 'ok';
                        }
                    }" class="flex items-center gap-3">

                    <!-- Сумма -->
                    <div class="flex items-center text-sm text-gray-700 font-semibold bg-gray-100 rounded-lg px-3 py-3 h-12">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2 text-gray-500">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h.008v.008H18V10.5Zm-12 0h.008v.008H6V10.5Z"/>
                        </svg>
                        Сумма: <span id="stock-balances" class="ml-2 font-mono" x-text="total"></span>
                    </div>

                    <!-- Input -->
                    <input id="balance" type="text" x-model="entered"
                           :class="{
                               'border border-blue-500': status === 'ok',
                               'border border-red-500': status === 'exceed' || status === 'invalid'
                           }"
                           class="h-12 w-32 px-3 rounded-lg focus:outline-none"
                           placeholder="Введите сумму!">

                    <!-- Подсказка -->
                    <div class="text-sm mt-1 text-red-500" x-text="status === 'exceed' ? 'Сумма превышает доступную!' : (status === 'invalid' ? 'Введите число!' : '')"></div>
                </div>

                <!-- Выбор передачи товарных денег  -->
                <div class="space-y-4 mt-4">
                    <!-- Варианты выбора, курьер, клиент, поставщик, как расход  -->
                    <div x-data="{
                            selected: null,
                            openCourierList: false,
                            openClientList: false,
                            selectedCourier: null,
                            selectedClient: null,
                            selectedExpense: null, // можно для расхода отдельное поле
                            expensePath: [],       // заменим path тут, чтобы было централизованно
                            select(type) {
                                this.selected = type;
                                this.openCourierList = false;
                                this.openClientList = false;

                                // сбрасываем лишние
                                if (type === 'courier') {
                                    this.selectedClient = null;
                                    this.expensePath = [];
                                }
                                if (type === 'client') {
                                    this.selectedCourier = null;
                                    this.expensePath = [];
                                }
                                if (type === 'expense') {
                                    this.selectedCourier = null;
                                    this.selectedClient = null;
                                }
                            }
                        }" class="w-full max-w-5xl space-y-4">


                        <!-- Курьер -->
                        <div class="flex items-center gap-2">
                            <input type="radio" id="radio_courier" name="delivery_type" value="courier"
                                   class="hidden peer/courier" x-model="selected" @change="select('courier'); openCourierList = false">
                            <label for="radio_courier"
                                   class="btn h-12 w-48 text-center px-4 border border-gray-300 bg-gray-50 text-gray-700 hover:bg-blue-100 rounded-xl peer-checked/courier:bg-blue-500 peer-checked/courier:text-white transition">
                                Курьеру
                            </label>

                            <div class="relative" x-show="selected === 'courier'" x-transition>
                                {% if couriers is empty %}
                                    <a href="/user/addUser?return_page=/transaction/distributionCommodityMoney"
                                       class="btn h-12 w-80 px-4 text-left border border-gray-300 bg-gray-50 text-gray-700 hover:bg-blue-100 rounded-xl flex items-center justify-between transition">
                                        <template x-if="!selectedCourier">
                                            <span>Создать курьера</span>
                                        </template>
                                        <template x-if="selectedCourier">
                                            <span x-text="selectedCourier.name"></span>
                                        </template>
                                    </a>
                                {% else %}
                                    <button @click="openCourierList = !openCourierList"
                                            class="btn h-12 w-80 px-4 text-left border border-gray-300 bg-gray-50 text-gray-700 hover:bg-blue-100 rounded-xl flex items-center justify-between transition">
                                        <template x-if="!selectedCourier">
                                            <span>Выберите курьера</span>
                                        </template>
                                        <template x-if="selectedCourier">
                                            <span x-text="selectedCourier.name"></span>
                                        </template>
                                        <svg class="w-4 h-4 ml-2 text-gray-400" fill="none" stroke="currentColor"
                                             stroke-width="2" viewBox="0 0 24 24">
                                            <path d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>

                                    <input type="hidden" name="courier_id" :value="selectedCourier?.id">
                                    <input type="hidden" name="courier_name" :value="selectedCourier?.name">

                                    <div x-show="openCourierList"
                                         @click.outside="openCourierList = false"
                                         class="absolute mt-2 w-80 z-50 bg-white border border-gray-200 rounded-xl shadow-xl p-2 space-y-1 transition-all duration-300"
                                         x-transition>
                                        {% for courier in couriers %}
                                            <div @click="selectedCourier = { id: {{ courier.id }}, name: '{{ courier.name }}' }; openCourierList = false"
                                                 class="cursor-pointer px-4 py-2 rounded-md hover:bg-gray-100 transition text-sm flex flex-col">
                                                <span class="font-medium text-gray-900">{{ courier.name }}</span>
                                                <span class="text-gray-600 text-xs truncate">{{ courier.email }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Клиент -->
                        <div class="flex items-center gap-2">
                            <input type="radio" id="radio_client" name="delivery_type" value="client"
                                   class="hidden peer/client" x-model="selected" @change="select('client'); openClientList = false">
                            <label for="radio_client"
                                   class="btn h-12 w-48 text-center px-4 border border-gray-300 bg-gray-50 text-gray-700 hover:bg-blue-100 rounded-xl peer-checked/client:bg-blue-500 peer-checked/client:text-white transition">
                                Клиенту
                            </label>

                            <div class="relative" x-show="selected === 'client'" x-transition>
                                {% if clients is empty %}
                                    <a href="/user/addUser?return_page=/transaction/distributionCommodityMoney"
                                       class="btn h-12 w-80 px-4 text-left border border-gray-300 bg-gray-50 text-gray-700 hover:bg-blue-100 rounded-xl flex items-center justify-between transition">
                                        <template x-if="!selectedClient">
                                            <span>Создать клиента</span>
                                        </template>
                                        <template x-if="selectedClient">
                                            <span x-text="selectedClient.name"></span>
                                        </template>
                                    </a>
                                {% else %}
                                    <button @click="openClientList = !openClientList"
                                            class="btn h-12 w-80 px-4 text-left border border-gray-300 bg-gray-50 text-gray-700 hover:bg-blue-100 rounded-xl flex items-center justify-between transition">
                                        <template x-if="!selectedClient">
                                            <span>Выберите клиента</span>
                                        </template>
                                        <template x-if="selectedClient">
                                            <span x-text="selectedClient.name"></span>
                                        </template>
                                        <svg class="w-4 h-4 ml-2 text-gray-400" fill="none" stroke="currentColor"
                                             stroke-width="2" viewBox="0 0 24 24">
                                            <path d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </button>

                                    <input type="hidden" name="client_id" :value="selectedClient?.id">
                                    <input type="hidden" name="client_name" :value="selectedClient?.name">

                                    <div x-show="openClientList"
                                         @click.outside="openClientList = false"
                                         class="absolute mt-2 w-80 z-50 bg-white border border-gray-200 rounded-xl shadow-xl p-2 space-y-1 transition-all duration-300"
                                         x-transition>
                                        {% for client in clients %}
                                            <div @click="selectedClient = { id: {{ client.id }}, name: '{{ client.name }}' }; openClientList = false"
                                                 class="cursor-pointer px-4 py-2 rounded-md hover:bg-gray-100 transition text-sm flex flex-col">
                                                <span class="font-medium text-gray-900">{{ client.name }}</span>
                                                <span class="text-gray-600 text-xs truncate">{{ client.email }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Определить как расход -->
                        <div class="flex items-center gap-2">
                            <!-- Определить как расход -->
                            <input type="radio" id="radio_expense" name="delivery_type" value="expense"
                                   class="hidden peer/expense" x-model="selected" @change="select('expense'); openExpenseList = false">

                            <label for="radio_expense"
                                   class="btn h-12 w-48 text-center px-4 border border-gray-300 bg-gray-50 text-gray-700
                                  hover:bg-blue-100 rounded-xl peer-checked/expense:bg-blue-500
                                  peer-checked/expense:text-white transition">
                                Определить как расход
                            </label>

                            <!-- Категории расходов  -->
                            <div class="relative" x-show="selected === 'expense'" x-transition>
                                <!-- Категории расходов -->
                                <div class="flex items-center justify-between w-full max-w-xl">
                                    <!-- Блок выбора категории -->
                                    <div x-data="{ open: false, level: 0, path: [] }" class="relative w-full">
                                        <!-- Кнопка выбора -->
                                        <button @click="open = !open"
                                                class="w-full min-w-[320px] max-w-xl text-left bg-white border border-gray-300 px-5 h-12 rounded-xl shadow-sm hover:shadow-md transition text-base font-medium flex items-center">
                                            <template x-if="path.length === 0">
                                                <span>Выберите категорию расхода</span>
                                            </template>
                                            <template x-if="path.length > 0">
                                                <span id="category" x-text="path.join(' > ')"></span>
                                            </template>
                                        </button>

                                        <!-- Выпадающее меню -->
                                        <div x-show="open"
                                             @click.outside="open = false"
                                             class="absolute mt-2 w-full z-50 bg-white border border-gray-200 rounded-xl shadow-xl p-4 space-y-3 transition-all duration-300"
                                             x-transition>
                                            <!-- Назад -->
                                            <div x-show="level > 0" class="mb-2">
                                                <button @click="level--; path.pop()" class="text-sm text-blue-600 hover:underline">← Назад</button>
                                            </div>

                                            {{ categories_html|raw }}
                                        </div>
                                    </div>

                                    <!-- Ссылка "Создать категорию" -->
                                    <a href="/categories/pageCategories?return_page=/transaction/distributionCommodityMoney" class="ml-4 text-sm font-semibold text-blue-600 hover:underline whitespace-nowrap">
                                        + Создать категорию
                                    </a>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Комментарий -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Комментарий</label>
                        <textarea id="comments"
                                  class="textarea textarea-bordered w-full"
                                  rows="3" maxlength="256"
                                  placeholder="Введите комментарий..."></textarea>
                    </div>

                    <!-- Кнопка Сохранить -->
                    <div class="text-right">
                        <label id="save_expense"
                               class="btn btn-primary btn-sm">Сохранить</label>
                    </div>
                </div>
            </li>
        </ul>
    </div>

    <input type="checkbox" id="save_expense_modal" class="modal-toggle"/>
    <div class="modal" role="dialog">
        <div class="modal-box space-y-4">
            <h1 class="text-lg font-bold text-gray-800">Распоряжение товарными деньгами</h1>

            <!-- Назначение -->
            <div>
                <div id="modal-purpose" class="text-xs uppercase font-semibold text-gray-500 mb-1 tracking-wide"></div>
                <div id="modal-appointment" class="bg-gray-100 px-3 py-2 rounded-xl text-sm text-gray-800"></div>
            </div>

            <!-- Сумма -->
            <div>
                <div class="text-xs uppercase font-semibold text-gray-500 mb-1 tracking-wide">Сумма</div>
                <div class="bg-green-100 px-3 py-2 rounded-xl text-sm text-green-700 font-medium"
                     id="modal-balance"></div>
            </div>

            <!-- Остаток -->
            <div>
                <div class="text-xs uppercase font-semibold text-gray-500 mb-1 tracking-wide">Остаток</div>
                <div class="bg-green-100 px-3 py-2 rounded-xl text-sm text-green-700 font-medium"
                     id="modal-remainder"></div>
            </div>


            <!-- Комментарий -->
            <div>
                <div class="text-xs uppercase font-semibold text-gray-500 mb-1 tracking-wide">Комментарий</div>
                <textarea readonly id="modal-comments"
                          class="w-full textarea textarea-bordered bg-gray-100 text-sm text-gray-800 rounded-xl"></textarea>
            </div>

            <!-- Кнопки -->
            <div class="modal-action pt-2">
                <button id="confirmExpense" class="btn btn-primary btn-sm">Подтвердить</button>
                <label for="save_expense_modal" class="btn btn-sm">Отменить</label>
            </div>
        </div>
    </div>

    <dialog id="errorModal" class="modal">
        <div class="modal-box">
            <h3 class="text-lg font-bold">Ошибка!</h3>
            <p id="errorText" class="py-4"></p>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Закрыть</button>
                </form>
            </div>
        </div>
    </dialog>

    <dialog id="success_modal" class="modal">
        <div class="modal-box">
            <h3 class="text-lg font-bold">Успех!</h3>
            <p id="successText" class="py-4">Успешно захоронили перевод товарных денег.</p>
            <div class="modal-action">
                <form method="dialog">
                    <a href="/transaction/distributionCommodityMoney" class="btn">готово</a>
                </form>
            </div>
        </div>
    </dialog>
    <script src="/assets/js/PostData.js?v=<?= time() ?>"></script>

    <script>
        const openErrorModal = (message) => {
            errorText.innerHTML = message;
            document.getElementById('errorModal').showModal();
        };


        const commentsModal = document.getElementById('modal-comments');
        const modalBalance = document.getElementById('modal-balance');
        const modalPurpose = document.getElementById('modal-purpose');
        const modalAppointment = document.getElementById('modal-appointment');
        const modalRemainder = document.getElementById('modal-remainder');
        let post = null;

        document.getElementById('save_expense').addEventListener('click', () => {
            const selectedRadio = document.querySelector('input[name="delivery_type"]:checked');
            const balanceInput = document.getElementById('balance');
            const enteredValue = balanceInput && typeof balanceInput.value !== 'undefined'
                ? balanceInput.value.trim()
                : '';
            const amount = Number(enteredValue);
            let categoryPath = '';

            if (!enteredValue || isNaN(Number(enteredValue)) || Number(enteredValue) <= 0) {
                openErrorModal('Укажите корректную сумму!');
                return;
            }

            if (!selectedRadio) {
                openErrorModal('Выберите назначение!');
                return;
            }

            const deliveryType = selectedRadio.value;
            let selectedId = null;
            let userName = null;

            if (deliveryType === 'courier') {
                const courierInput = document.querySelector('input[name="courier_id"]');
                const userinput = document.querySelector('input[name="courier_name"]');
                if (courierInput && courierInput.value) {
                    selectedId = courierInput.value;
                    userName = userinput.value;
                } else {
                    openErrorModal('Выберите курьера!');
                    return;
                }
            } else if (deliveryType === 'client') {
                const clientInput = document.querySelector('input[name="client_id"]');
                const userinput = document.querySelector('input[name="client_name"]');

                if (clientInput && clientInput.value) {
                    selectedId = clientInput.value;
                    userName = userinput.value;
                } else {
                    openErrorModal('Выберите клиента!');
                    return;
                }
            } else if (deliveryType === 'expense') {
                const categoryElement = document.getElementById('category');
                categoryPath = categoryElement ? categoryElement.textContent.trim() : '';
                if (!categoryPath) {
                    openErrorModal('Выберите категорию назначения!');
                    return;
                }

                userName = categoryPath;
            }

            const commentsTextarea = document.getElementById('comments');
            const commentValue = commentsTextarea ? commentsTextarea.value.trim() : '';
            if (!commentValue) {
                openErrorModal('Введите комментарий!');
                return;
            }

            const stockBalances = document.getElementById('stock-balances');
            const summ = Number(stockBalances.innerHTML) || 0;

            const purpose = {
                courier: 'Курьеру',
                client: 'Клиенту',
                supplier: 'Поставщику',
                client_services: 'Клиент услуги',
                expense: 'Расход',
            };

            post = {
                delivery_type: deliveryType,
                selected_id: selectedId,
                category_path: categoryPath,
                amount: amount || 0,
                comments: commentValue,
            }

            modalPurpose.textContent = purpose[deliveryType] || 'Не известно';
            modalAppointment.textContent = userName || 'Не известно';
            modalBalance.textContent = amount || 0;
            commentsModal.textContent = commentValue;
            modalRemainder.textContent = summ - (amount || 0);
            document.getElementById('save_expense_modal').checked = true;
        });

        document.getElementById('confirmExpense').addEventListener('click', async () => {

            if (!post) {
                openErrorModal('Ошибка сбора данных!');
                return;
            }

            const result = await postData('/entities/definitionCommodityMoney', post);

            document.getElementById('save_expense_modal').checked = false;

            if (result === 'error') {
                openErrorModal('Ошибка при отправке данных!');
                return;
            }

            if (result.success) {
                document.getElementById('success_modal').showModal();
            } else {
                openErrorModal('Не удалось сохранить доход!');
            }
        });

        document.getElementById('save_expense_modal').checked = false;
    </script>


{% endblock %}
