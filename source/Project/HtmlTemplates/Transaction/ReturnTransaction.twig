{% extends './Navbar/Navbar.twig' %}

{% block content %}
    <div class="w-full max-w-5xl mx-auto px-4 pb-96 my-8">
        <div class="border border-base-300 rounded-xl shadow-md p-8 bg-base-100">
            <h2 class="text-2xl font-bold mb-6">Создать возврат денег</h2>

            <form id="returnForm"  action="/transaction/storereturntransaction" method="POST" class="space-y-6">
                <!-- Откуда и Сумма в одну строку -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-control">
                        <label class="label mb-2">
                            <span class="label-text">Откуда перевод (наши компании)</span>
                        </label>
                        <select name="from_account" class="select select-bordered w-full" required>
                            <option disabled selected value="">Выберите отправителя</option>
                            {% for acc in our_accounts %}
                                <option value="{{ acc.id }}">{{ acc.company_name }} ({{ acc.inn }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Сумма -->
                    <div class="form-control">
                        <label class="label mb-2">
                            <span class="label-text">Укажите сумму</span>
                        </label>
                        <input name="amount" type="number" placeholder="Например, 1000" class="input input-bordered w-full" />
                    </div>
                </div>

                <!-- Куда перевод (компания получателя) -->
                <div class="form-control">
                    <label class="label mb-2">
                        <span class="label-text">Куда перевод</span>
                    </label>
                    <select name="to_account" class="select select-bordered w-full" required>
                        <option disabled selected value="">Выберите получателя</option>
                        <optgroup label="Компании">
                            {% for cl in companies %}
                                <option value="{{ cl.id }}">{{ cl.company_name }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
                {#                <pre>{{ suppliers|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>#}
                <!-- Выбор пользователя -->
                <div class="form-control">
                    <label class="label mb-2">
                        <span class="label-text">Выберите пользователя</span>
                    </label>
                    <select name="user_id" class="select select-bordered w-full" >
                        <option disabled selected value="">Выберите пользователя</option>

                        <optgroup label="Поставщики">
                            {% for s in suppliers %}
                                <option value="supplier_{{ s.id }}">{{ s.username }}</option>
                            {% endfor %}
                        </optgroup>

                        <optgroup label="Курьеры">
                            {% for c in couriers %}
                                <option value="courier_{{ c.id }}">{{ c.name ?? c.company_name }}</option>
                            {% endfor %}
                        </optgroup>

                        <optgroup label="Клиенты">
                            {% for cl in clients %}
                                <option value="client_{{ cl.id }}">{{ cl.name }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-control">
                    <label class="label mb-2">
                        <span class="label-text">Дата поступления</span>
                    </label>
                    <input
                            type="date"
                            name="date_received"
                            class="input input-bordered w-full"
                            value="{{ 'now'|date('Y-m-d') }}"
                            required
                    />
                </div>

                <!-- Описание -->
                <div class="form-control">
                    <label class="label mb-2">
                        <span class="label-text">Описание транзакции</span>
                    </label>
                    <textarea
                            name="description"
                            class="textarea textarea-bordered w-full"
                            rows="4"
                            maxlength="256"
                            placeholder="Описание..."
                    ></textarea>
                </div>

                <!-- Кнопка -->
                <div class="form-control">
                    <button type="submit" class="btn btn-primary w-full">Создать</button>
                </div>
            </form>
        </div>
    </div>
    <input type="checkbox" id="retSuccess" class="modal-toggle"/>
    <div class="modal" role="dialog">
        <div class="modal-box bg-base-100">
            <h3 class="font-bold text-lg">Успех</h3>
            <p id="retSuccessText" class="py-4">Возврат успешно создан.</p>
            <div class="modal-action">
                <label for="retSuccess" class="btn">Ок</label>
            </div>
        </div>
    </div>

    <input type="checkbox" id="retError" class="modal-toggle"/>
    <div class="modal" role="dialog">
        <div class="modal-box bg-base-100">
            <h3 class="font-bold text-lg text-error">Ошибка</h3>
            <p id="retErrorText" class="py-4">Произошла ошибка.</p>
            <div class="modal-action">
                <label for="retError" class="btn">Ок</label>
            </div>
        </div>
    </div>
    <script>
        function openRetSuccess(msg) {
            document.getElementById('retSuccessText').textContent = msg || 'Возврат успешно создан.';
            document.getElementById('retSuccess').checked = true;
        }
        function openRetError(msg) {
            document.getElementById('retErrorText').textContent = msg || 'Произошла ошибка при отправке формы';
            document.getElementById('retError').checked = true;
        }

        document.getElementById('returnForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);

            // Базовая валидация
            if (!formData.get('from_account') || !formData.get('to_account') || !formData.get('amount') || !formData.get('date_received')) {
                openRetError('Заполните обязательные поля');
                return;
            }

            try {
                const res = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });

                let result;
                try {
                    result = await res.json();
                } catch {
                    openRetError('Некорректный ответ сервера (не JSON). Возможно, сессия истекла.');
                    return;
                }

                if (result.status === 'ok') {
                    openRetSuccess('Возврат успешно создан.');
                    form.reset();
                } else {
                    const msg = result.value || result.error || 'Неизвестная ошибка';
                    openRetError(msg);
                }
            } catch (err) {
                openRetError('Ошибка сети: ' + (err?.message || err));
            }
        });
    </script>
{% endblock %}
