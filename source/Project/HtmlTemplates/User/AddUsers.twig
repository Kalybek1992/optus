{% extends './Navbar/Navbar.twig' %}

{% block content %}

    {% include './Breadcrumb/AddUsers.twig' %}

    <dialog id="error_email" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-gray-100 border border-gray-300">
            <h3 class="text-lg font-bold text-center text-gray-700">Ошибка!</h3>
            <p class="py-4 text-center text-gray-700">Такая почта уже зарегистрирована.</p>
            <div class="modal-action">
                <form method="dialog" class="w-full">
                    <button class="btn w-full">Закрыть</button>
                </form>
            </div>
        </div>
    </dialog>

    <dialog id="error" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-gray-100 border border-gray-300">
            <h3 class="text-lg font-bold text-center text-gray-700">Ошибка!</h3>
            <p class="py-4 text-center text-gray-700">Что-то пошло не так, повторите еще раз.</p>
            <div class="modal-action">
                <form method="dialog" class="w-full">
                    <button class="btn w-full">Закрыть</button>
                </form>
            </div>
        </div>
    </dialog>

    <dialog id="success" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box">
            <h3 class="text-lg font-bold text-center">Успех!</h3>
            <p class="py-4 text-center">Пользователь добавлен с указанными данными:</p>

            <div class="space-y-4">
                <!-- Имя -->
                <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg relative">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold">Имя:</span>
                        <span id="displayName" class="text-gray-700 break-all"></span>
                    </div>
                </div>
                <!-- Роль -->
                <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg relative">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold">Роль:</span>
                        <span id="displayRole" class="text-gray-700 break-all"></span>
                    </div>
                </div>
                <!-- Пароль -->
                <div id="password-modal" class="flex items-center justify-between p-3 bg-gray-100 rounded-lg relative">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold">Пароль:</span>
                        <span id="displayPassword" class="text-gray-700 break-all"></span>
                    </div>
                    <button type="button" id="copyPassword" class="text-gray-500 hover:text-gray-800 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8l6 6v4"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 2v6h6"></path>
                        </svg>
                    </button>
                </div>
                <!-- Почта -->
                <div id="email-modal" class="flex items-center justify-between p-3 bg-gray-100 rounded-lg relative">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold">Почта:</span>
                        <span id="displayEmail" class="text-gray-700 break-all"></span>
                    </div>
                    <button type="button" id="copyEmail" class="text-gray-500 hover:text-gray-800 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8l6 6v4"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 2v6h6"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="modal-action">
                <form method="dialog" class="w-full">
                    <button id="success-modal-btn" class="btn w-full">Закрыть</button>
                </form>
            </div>
        </div>
    </dialog>


    <div class="w-full max-w-md p-8 bg-white rounded-lg shadow-md mx-auto mt-[50px]">
        <!-- Заголовок с иконкой -->
        <div class="flex items-center justify-center mb-6">
            <svg class="w-10 h-10 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a8 8 0 00-8 8h16a8 8 0 00-8-8z"/>
            </svg>
            <h2 class="text-3xl font-bold text-center">Добавить пользователя</h2>
        </div>

        <form id="addUserForm" action="#" method="POST">
            <!-- Name input -->
            <div class="relative mb-4">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                             stroke="currentColor" class="w-5 h-5 text-gray-400">
                              <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                        </svg>
                    </span>
                <input type="text" id="name" name="name" placeholder="Имя пользователя" required
                       class="w-full pl-10 p-2 border rounded-md"/>
            </div>

            <!-- Email input -->
            <div class="" id="email-input">
                <div class="relative mb-4">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </span>
                    <input type="email" id="email" name="email" placeholder="Электронная почта" required
                           class="w-full pl-10 p-2 border rounded-md "/>
                </div>
            </div>


            <!-- Role selection -->
            <div class="relative mb-4">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                         stroke="currentColor" class="w-5 h-5 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"/>
                    </svg>
                </span>
                <select id="role" name="role" required
                        class="w-full pl-10 p-2 border rounded-md bg-white appearance-none">
                    <option value="">Выберите роль</option>
                    <option value="admin">Администратор</option>
                    <option value="client">Клиент</option>
                    <option value="client_services">Клиент услуги</option>
                    <option value="supplier">Поставщик</option>
                    <option value="courier">Курьер</option>
                    <option value="shop">Магазин</option>
                </select>
            </div>
            <!-- Hidden fields: -->
            <div id="percent" class="hidden">
                <!-- Проценты -->
                <div class="relative mb-4">
                     <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                              stroke="currentColor" class="w-5 h-5 text-gray-400">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="m8.99 14.993 6-6m6 3.001c0 1.268-.63 2.39-1.593 3.069a3.746 3.746 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043 3.745 3.745 0 0 1-3.068 1.593c-1.268 0-2.39-.63-3.068-1.593a3.745 3.745 0 0 1-3.296-1.043 3.746 3.746 0 0 1-1.043-3.297 3.746 3.746 0 0 1-1.593-3.068c0-1.268.63-2.39 1.593-3.068a3.746 3.746 0 0 1 1.043-3.297 3.745 3.745 0 0 1 3.296-1.042 3.745 3.745 0 0 1 3.068-1.594c1.268 0 2.39.63 3.068 1.593a3.745 3.745 0 0 1 3.296 1.043 3.746 3.746 0 0 1 1.043 3.297 3.746 3.746 0 0 1 1.593 3.068ZM9.74 9.743h.008v.007H9.74v-.007Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm4.125 4.5h.008v.008h-.008v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"/>
                         </svg>
                     </span>
                    <input type="number" id="percentage" name="percentage" placeholder="Проценты"
                           min="0" max="100"
                           class="w-full pl-10 p-2 border rounded-md"/>
                </div>
            </div>

            <div id="suplers" class="hidden">
                <div class="relative mb-4">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                             stroke="currentColor" class="w-5 h-5 text-gray-400">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 0 0-3.213-9.193 2.056 2.056 0 0 0-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 0 0-10.026 0 1.106 1.106 0 0 0-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12"/>
                        </svg>
                    </span>
                    <select name="suppler" required
                            class="w-full pl-10 p-2 border rounded-md bg-white appearance-none">
                        <option value="">Выберите поставщика</option>
                        {% for supplier in suppliers %}
                            <option id="suppler" value="{{ supplier.supplier_id }}">{{ supplier.username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Password input -->
            <div class="" id="password-input">
                <div class="relative mb-4">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                         stroke="currentColor" class="w-5 h-5 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z"/>
                    </svg>
                </span>
                    <input type="text" id="password" name="password" required placeholder="Пароль" minlength="8"
                           pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}"
                           title="Пароль должен содержать не менее 8 символов, включая цифры, строчные и заглавные буквы"
                           class="w-full pl-10 p-2 border rounded-md"/>
                    <!-- Кнопка копировать -->
                    <button type="button" id="copyPassword"
                            class="absolute right-2 top-2 text-gray-600 hover:text-gray-900">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8l6 6v4"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 2v6h6"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Generate Password button -->
            <div class="" id="generate-password-button">
                <button type="button" id="generatePassword"
                        class="btn w-full py-2 text-lg bg-gray-500 text-white rounded-md mt-2 hover:bg-gray-600 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Сгенерировать пароль
                </button>
            </div>

            <!-- Submit Button -->
            <button type="submit" formnovalidate
                    class="btn w-full px-8 py-2 text-lg bg-blue-500 text-white rounded-md mt-4 hover:bg-blue-600 flex items-center justify-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                Добавить пользователя
            </button>
        </form>
    </div>

    <script src="/assets/js/PostData.js?v=<?= time() ?>"></script>

    <script>

        // при закрытии модалки успеха — перезагрузим страницу
        const successModalBtn = document.getElementById('success-modal-btn');
        if (successModalBtn) {
            successModalBtn.addEventListener('click', function () {
                location.reload();
            });
        }

        // генерация пароля
        const generateBtn = document.getElementById('generatePassword');
        if (generateBtn) {
            generateBtn.addEventListener('click', function () {
                const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                let password = "";
                for (let i = 0; i < 13; i++) {
                    password += charset.charAt(Math.floor(Math.random() * charset.length));
                }
                const passwordInput = document.getElementById('password');
                if (passwordInput) passwordInput.value = password;
            });
        }

        // копирование пароля из поля ввода (если есть кнопка)
        const copyPasswordInputBtn = document.querySelector('#password-input button#copyPassword');
        if (copyPasswordInputBtn) {
            copyPasswordInputBtn.addEventListener('click', function () {
                const passwordInput = document.getElementById('password');
                if (!passwordInput) return;
                passwordInput.select();
                passwordInput.setSelectionRange(0, 99999);
                try {
                    document.execCommand("copy");
                } catch (e) {
                    // fallback: использовать clipboard API
                    if (navigator.clipboard) navigator.clipboard.writeText(passwordInput.value).catch(()=>{});
                }
            });
        }

        // удалить первый пустой option при выборе роли (если есть)
        document.addEventListener('DOMContentLoaded', function () {
            const roleSelect = document.getElementById('role');
            if (!roleSelect) return;

            roleSelect.addEventListener('change', function () {
                const firstOption = roleSelect.querySelector('option[value=""]');
                if (firstOption) {
                    firstOption.remove();
                }
            });
        });

        // селектор поставщика (может быть null, если в DOM нет)
        const selectElement = document.querySelector('select[name="suppler"]');

        // логика показа/скрытия полей при смене роли
        const roleSelectGlobal = document.getElementById('role');
        if (roleSelectGlobal) {
            roleSelectGlobal.addEventListener('change', function () {
                const percent = document.getElementById('percent');
                const emailInput = document.getElementById('email-input');
                const passwordInput = document.getElementById('password-input');
                const generatePasswordButton = document.getElementById('generate-password-button');
                const suplers = document.getElementById('suplers');

                const passwordModal = document.getElementById('password-modal');
                const emailModal = document.getElementById('email-modal');

                if (this.value === 'client') {
                    if (percent) percent.classList.remove('hidden');
                    if (emailInput) emailInput.classList.add('hidden');
                    if (passwordInput) passwordInput.classList.add('hidden');

                    if (passwordModal) passwordModal.classList.add('hidden');
                    if (emailModal) emailModal.classList.add('hidden');

                    if (generatePasswordButton) generatePasswordButton.classList.add('hidden');
                } else {
                    if (emailInput) emailInput.classList.remove('hidden');
                    if (passwordInput) passwordInput.classList.remove('hidden');
                    if (generatePasswordButton) generatePasswordButton.classList.remove('hidden');

                    if (passwordModal) passwordModal.classList.remove('hidden');
                    if (emailModal) emailModal.classList.remove('hidden');

                    if (percent) percent.classList.add('hidden');
                }

                // только для client_services показываем выбор поставщика
                if (this.value === 'client_services') {
                    if (suplers) suplers.classList.remove('hidden');
                    if (selectElement) {
                        selectElement.removeAttribute('disabled');
                        selectElement.setAttribute('required', 'required');
                    }
                } else {
                    if (suplers) suplers.classList.add('hidden');
                    if (selectElement) {
                        selectElement.setAttribute('disabled', 'disabled');
                        selectElement.removeAttribute('required');
                    }
                }
            });
        }

        // обработка отправки формы
        const form = document.getElementById('addUserForm');
        if (form) {
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const name = document.getElementById('name') ? document.getElementById('name').value.trim() : '';
                const email = document.getElementById('email') ? document.getElementById('email').value.trim() : '';
                const password = document.getElementById('password') ? document.getElementById('password').value : '';
                const role = document.getElementById('role') ? document.getElementById('role').value : '';
                const percentEl = document.getElementById('percentage');
                const percent = percentEl ? (parseFloat(percentEl.value) || 0) : 0;
                const selectEl = document.querySelector('select[name="suppler"]');
                const selectedValue = selectEl ? selectEl.value || 0 : 0;

                let result = 'error';

                if (role === 'client') {
                    // клиент — только имя, роль и проценты
                    result = await postData('/user/addUserRole', {
                        name: name,
                        role: role,
                        percent: percent,
                    });
                } else if (role === 'client_services') {
                    // клиент услуги — имя, почта, пароль, поставщик
                    result = await postData('/user/addUserRole', {
                        name: name,
                        email: email,
                        role: role,
                        password: password,
                        supplier_id: selectedValue,
                    });
                } else if (role === 'supplier' || role === 'courier' || role === 'shop') {
                    // поставщик, курьер и магазин — имя, почта, пароль
                    result = await postData('/user/addUserRole', {
                        name: name,
                        email: email,
                        role: role,
                        password: password,
                    });
                } else {
                    // прочие роли (например admin) — отправляем базовые данные
                    result = await postData('/user/addUserRole', {
                        name: name,
                        email: email,
                        role: role,
                        password: password,
                    });
                }

                // обработка ошибок ответа
                if (result && result.status === 'error' && result.value === 'repeat_email') {
                    const modalEmail = document.getElementById('error_email');
                    if (modalEmail && typeof modalEmail.showModal === 'function') modalEmail.showModal();
                    return;
                }

                if (result && result.status === 'error') {
                    const modalErr = document.getElementById('error');
                    if (modalErr && typeof modalErr.showModal === 'function') modalErr.showModal();
                    return;
                }

                if (result === 'error') {
                    const modalErr = document.getElementById('error');
                    if (modalErr && typeof modalErr.showModal === 'function') modalErr.showModal();
                    return;
                }

                // успех
                const successModal = document.getElementById('success');
                if (successModal && typeof successModal.showModal === 'function') successModal.showModal();

                const roleTranslations = {
                    admin: 'Администратор',
                    client: 'Клиент',
                    supplier: 'Поставщик',
                    courier: 'Курьер',
                    client_services: 'Клиент услуги',
                    shop: 'Магазин'
                };

                // Заполняем данные в модалке
                const displayName = document.getElementById('displayName');
                const displayRole = document.getElementById('displayRole');
                const displayEmail = document.getElementById('displayEmail');
                const displayPassword = document.getElementById('displayPassword');

                if (displayName) displayName.textContent = name;
                if (displayRole) displayRole.textContent = roleTranslations[role] || role;
                if (displayEmail) displayEmail.textContent = email;
                if (displayPassword) displayPassword.textContent = password;

                // Кнопки копирования в модалке успеха
                const copyEmailBtn = document.getElementById('copyEmail');
                if (copyEmailBtn) {
                    copyEmailBtn.addEventListener('click', function () {
                        const emailText = displayEmail ? displayEmail.textContent : '';
                        if (navigator.clipboard) navigator.clipboard.writeText(emailText).catch(()=>{});
                    });
                }

                const copyPasswordModalBtn = document.querySelector('#password-modal button#copyPassword');
                if (copyPasswordModalBtn) {
                    copyPasswordModalBtn.addEventListener('click', function () {
                        const pwd = displayPassword ? displayPassword.textContent : '';
                        if (navigator.clipboard) navigator.clipboard.writeText(pwd).catch(()=>{});
                    });
                }

                form.reset();
            });
            // сброс формы при загрузке скрипта (как было)
            form.reset();
        }
    </script>



{% endblock %}
