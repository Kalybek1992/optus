{% extends './Navbar/Navbar.twig' %}

{% block content %}

    <div class="w-full max-w-5xl mx-auto px-3 sm:px-4 pb-32 my-6 sm:my-10">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-center sm:text-left">
            Деньги из других источников
        </h2>

        <ul class="list bg-base-100 rounded-lg shadow-md space-y-4 sm:space-y-6">
            <li class="relative p-3 sm:p-4 bg-base-200 transition rounded-lg border border-gray-300">

                <!-- Сумма -->
                <div x-data="{
                entered: '',
                get status() {
                    if (!this.entered || isNaN(this.entered) || Number(this.entered) <= 0) return 'invalid';
                    return 'ok';
                }
            }" class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-4">

                    <input id="balance"
                           type="text"
                           x-model="entered"
                           :class="{
                           'border border-blue-500': status === 'ok',
                           'border border-red-500': status === 'invalid'
                       }"
                           class="h-12 w-full sm:w-48 px-3 rounded-lg focus:outline-none text-base"
                           placeholder="Введите сумму">

                    <div class="text-xs sm:text-sm text-red-500"
                         x-text="status === 'invalid' ? 'Введите корректное число!' : ''">
                    </div>
                </div>

                <!-- Дата -->
                <div class="flex flex-col gap-2 mb-4">
                    <span class="text-sm sm:text-lg font-bold text-gray-700 uppercase tracking-wide">Дата</span>

                    <input type="text"
                           id="date_input"
                           placeholder="Введите дату"
                           autocomplete="off"
                           class="datepicker_from w-full max-w-[220px] sm:h-[56px] h-12 px-4 bg-white rounded-xl shadow-sm text-base font-semibold text-gray-700 border border-gray-200"/>
                </div>

                <!-- Категории расходов -->
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between w-full gap-3 sm:gap-4 mb-4 max-w-[520px]">

                    <div x-data="{ open: false, level: 0, path: [] }" class="relative w-full">
                        <button @click="open = !open"
                                class="w-full text-left bg-white border border-gray-300 px-4 py-3 rounded-md shadow-sm hover:shadow-md transition font-medium text-sm sm:text-base">
                            <template x-if="path.length === 0">
                                <span>Выберите категорию расхода</span>
                            </template>
                            <template x-if="path.length > 0">
                                <span id="category" x-text="path.join(' > ')"></span>
                            </template>
                        </button>

                        <div x-show="open"
                             @click.outside="open = false"
                             class="absolute mt-2 w-full z-50 bg-white border border-gray-200 rounded-xl shadow-xl p-3 space-y-3 transition-all duration-300 max-h-[300px] overflow-y-auto"
                             x-transition>
                            <div x-show="level > 0" class="mb-2">
                                <button @click="level--; path.pop()" class="text-sm text-blue-600 hover:underline">← Назад</button>
                            </div>

                            {{ categories_html|raw }}
                        </div>
                    </div>

                    <a href="/categories/pageCategories?return_page=/entities/linkExpenses?legal_id={{ entitie.id }}"
                       class="text-sm font-semibold text-blue-600 hover:underline whitespace-nowrap">
                        + Создать категорию
                    </a>
                </div>

                <!-- Комментарий -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Комментарий</label>
                    <textarea id="comments"
                              class="textarea textarea-bordered w-full text-base"
                              rows="4" maxlength="256"
                              placeholder="Введите комментарий..."></textarea>
                </div>

                <!-- Кнопка Сохранить -->
                <div class="text-center sm:text-right mt-5">
                    <label id="save_expense"
                           class="btn btn-primary btn-md w-full sm:w-auto">
                        Сохранить
                    </label>
                </div>
            </li>
        </ul>
    </div>



    <!-- Модальное окно подтверждения -->
    <input type="checkbox" id="save_expense_modal" class="modal-toggle"/>
    <div class="modal">
        <div class="modal-box w-full max-w-md mx-2 sm:mx-auto p-4 sm:p-6 space-y-4 rounded-xl">
            <h1 class="text-lg sm:text-xl font-bold text-gray-800 text-center sm:text-left">
                Деньги из других источников
            </h1>

            <div>
                <div class="text-xs uppercase font-semibold text-gray-500 mb-1 tracking-wide">Сумма</div>
                <div class="bg-green-100 px-3 py-2 rounded-xl text-sm text-green-700 font-medium"
                     id="modal-balance"></div>
            </div>

            <div>
                <div class="text-xs uppercase font-semibold text-gray-500 mb-1 tracking-wide">Категория</div>
                <div class="bg-gray-100 px-3 py-2 rounded-xl text-sm text-gray-800 font-medium"
                     id="modal-category"></div>
            </div>

            <div>
                <div class="text-xs uppercase font-semibold text-gray-500 mb-1 tracking-wide">Дата</div>
                <div class="bg-gray-100 px-3 py-2 rounded-xl text-sm text-gray-800 font-medium"
                     id="modal-date"></div>
            </div>

            <div>
                <div class="text-xs uppercase font-semibold text-gray-500 mb-1 tracking-wide">Комментарий</div>
                <textarea readonly id="modal-comments"
                          class="w-full textarea textarea-bordered bg-gray-100 text-sm text-gray-800 rounded-xl"></textarea>
            </div>

            <div class="modal-action flex flex-col sm:flex-row gap-2 pt-2">
                <button id="confirmExpense" class="btn btn-primary w-full sm:w-auto">Подтвердить</button>
                <label for="save_expense_modal" class="btn w-full sm:w-auto">Отменить</label>
            </div>
        </div>
    </div>

    <!-- Модалки ошибок и успеха -->
    <dialog id="errorModal" class="modal">
        <div class="modal-box w-full max-w-md mx-2 p-4 sm:p-6">
            <h3 class="text-lg font-bold">Ошибка!</h3>
            <p id="errorText" class="py-4"></p>
            <div class="modal-action">
                <form method="dialog" class="w-full">
                    <button class="btn w-full sm:w-auto px-6">
                        Закрыть
                    </button>
                </form>
            </div>
        </div>
    </dialog>

    <dialog id="success_modal" class="modal">
        <div class="modal-box w-full max-w-md mx-2 p-4 sm:p-6">
            <h3 class="text-lg font-bold">Успех!</h3>
            <p id="successText" class="py-4">Данные успешно сохранены.</p>
            <div class="modal-action w-full">
                <form method="dialog" class="w-full">
                    <a href="/courier/incomeotherform"
                       class="btn w-full sm:w-auto px-6 bg-blue-600 hover:bg-blue-700 text-white">
                        Готово
                    </a>
                </form>
            </div>
        </div>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css" />

    <script>
        document.querySelectorAll('.datepicker_from').forEach(field => {
            new Pikaday({
                field: field,
                format: 'DD.MM.YYYY',
                firstDay: 1,
                i18n: {
                    previousMonth: 'Предыдущий',
                    nextMonth: 'Следующий',
                    months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
                    weekdays: ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'],
                    weekdaysShort: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб']
                },
                toString(date) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                },
                parse(dateString) {
                    const parts = dateString.split('.');
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day);
                }
            });
        });

        const openErrorModal = (message) => {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorModal').showModal();
        };


        let post = null;

        document.getElementById('save_expense').addEventListener('click', () => {
            const balanceInput = document.getElementById('balance');
            const dateInput = document.getElementById('date_input');
            const commentsTextarea = document.getElementById('comments');
            const categorySpan = document.getElementById('category');

            const amount = Number(balanceInput.value.trim());
            const dateValue = dateInput.value.trim();
            const commentValue = commentsTextarea.value.trim();
            const categoryValue = categorySpan ? categorySpan.innerText.trim() : '';

            if (!amount || isNaN(amount) || amount <= 0) {
                openErrorModal('Введите корректную сумму!');
                return;
            }

            if (!dateValue) {
                openErrorModal('Укажите дату!');
                return;
            }

            if (!categoryValue) {
                openErrorModal('Выберите категорию!');
                return;
            }

            if (!commentValue) {
                openErrorModal('Введите комментарий!');
                return;
            }

            post = {
                amount: amount,
                date: dateValue,
                category: categoryValue,
                comments: commentValue
            };

            // Заполнение модалки
            document.getElementById('modal-balance').textContent = amount;
            document.getElementById('modal-category').textContent = categoryValue;
            document.getElementById('modal-date').textContent = dateValue;
            document.getElementById('modal-comments').value = commentValue;

            document.getElementById('save_expense_modal').checked = true;
        });

        document.getElementById('confirmExpense').addEventListener('click', async () => {
            if (!post) {
                openErrorModal('Ошибка сбора данных!');
                return;
            }

            const result = await postData('/courier/storeIncomeOther', post);

            document.getElementById('save_expense_modal').checked = false;

            if (result === 'error') {
                openErrorModal('Ошибка при отправке данных!');
                return;
            }

            if (result.success) {
                document.getElementById('success_modal').showModal();
            } else {
                openErrorModal('Не удалось сохранить!');
            }
        });

        document.getElementById('save_expense_modal').checked = false;
    </script>
{% endblock %}