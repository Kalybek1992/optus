{% extends './Navbar/Navbar.twig' %}

{% block content %}
    <div class="max-w-7xl mx-auto p-4 md:p-6">

        <h1 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">
            Неподтвержденные поступления
        </h1>

        <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:gap-2">
        <span class="text-gray-600 text-sm md:text-base">
            Сумма неподтвержденного баланса:
        </span>
            <span class="text-2xl font-semibold text-blue-600">
            {{ courier.balance_unaccepted|number_format(0, ',', ' ') }} ₽
        </span>
        </div>

        {% if pending is empty %}
            <div class="alert bg-blue-50 border border-blue-200 text-blue-700 rounded-lg py-3 px-4">
                Нет записей
            </div>
        {% else %}
            <div class="rounded-xl shadow-md border border-gray-200 overflow-hidden">
                <table class="table w-full">
                    <thead class="bg-gray-100 text-gray-700 text-sm">
                    <tr class="divide-x divide-gray-200">
                        <th class="px-4 py-2 text-left whitespace-nowrap">Дата</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap hidden sm:table-cell">Дата выдачи</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap">Сумма</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap hidden md:table-cell">Категория</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap hidden lg:table-cell">От кого</th>
                        <th class="px-4 py-2 text-left hidden xl:table-cell">Комментарий</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap hidden xl:table-cell">Номер карты</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap hidden xl:table-cell">Компания</th>
                        <th class="px-4 py-2"></th>
                    </tr>
                    </thead>

                    <tbody class="divide-y divide-gray-200">
                        {% for r in pending %}
                            <tr class="divide-x divide-gray-200 {% if loop.index is odd %}bg-gray-50{% else %}bg-white{% endif %}">
                                <td class="px-4 py-3 text-sm whitespace-nowrap">{{ r.date }}</td>

                                <td class="px-4 py-3 text-sm whitespace-nowrap hidden sm:table-cell">
                                    {{ r.issue_date }}
                                </td>

                                <td class="px-4 py-3 font-semibold whitespace-nowrap">
                                    {{ r.amount|number_format(0, ',', ' ') }} ₽
                                </td>

                                <td class="px-4 py-3 hidden md:table-cell">
                                    {{ r.category }}
                                </td>

                                <td class="px-4 py-3 hidden lg:table-cell">
                                    {{ r.supplier_name }}
                                </td>

                                <td class="px-4 py-3 hidden xl:table-cell max-w-[220px] truncate"
                                    title="{{ r.comments }}">
                                    {{ r.comments }}
                                </td>

                                <td class="px-4 py-3 hidden xl:table-cell whitespace-nowrap">
                                    {{ r.card_number|slice(0,4) }} {{ r.card_number|slice(4,4) }}
                                    {{ r.card_number|slice(8,4) }} {{ r.card_number|slice(12,4) }}
                                </td>

                                <td class="px-4 py-3 hidden xl:table-cell">
                                    {{ r.company_name }}
                                </td>

                                <!-- Кнопка — ТОЛЬКО desktop -->
                                <td class="px-4 py-3 text-right whitespace-nowrap hidden sm:table-cell">
                                    <button
                                            data-pending-id="{{ r.id }}"
                                            class="confirm btn bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow
                                           text-sm px-3 py-1.5">
                                        Подтвердить
                                    </button>
                                </td>
                            </tr>

                            <!-- Мобильная версия -->
                            <tr class="sm:hidden bg-white">
                                <td colspan="9" class="px-4 py-3 text-xs text-gray-600 space-y-1">
                                    <div><b>Дата выдачи:</b> {{ r.issue_date }}</div>
                                    <div><b>Категория:</b> {{ r.category }}</div>
                                    <div><b>От кого:</b> {{ r.supplier_name }}</div>

                                    {% if r.comments %}
                                        <div><b>Комментарий:</b> {{ r.comments }}</div>
                                    {% endif %}

                                    <div>
                                        <b>Карта:</b>
                                        {{ r.card_number|slice(0,4) }} {{ r.card_number|slice(4,4) }}
                                        {{ r.card_number|slice(8,4) }} {{ r.card_number|slice(12,4) }}
                                    </div>

                                    <div><b>Компания:</b> {{ r.company_name }}</div>
                                    <button
                                            data-pending-id="{{ r.id }}"
                                            class="confirm w-full mt-2 btn bg-blue-600 hover:bg-blue-700
                                           text-white rounded-lg shadow py-2">
                                        Подтвердить
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>
    <div class="flex items-center justify-center py-6">
        {% include './Pagination/Pagination.twig' %}
    </div>

    <!-- SUCCESS MODAL -->
    <input type="checkbox" id="okModal" class="modal-toggle"/>
    <div class="modal" role="dialog">
        <div class="modal-box bg-white border border-gray-200 rounded-xl">
            <h3 class="font-bold text-lg text-gray-800">Успех</h3>
            <p id="okText" class="py-4 text-gray-700">Подтверждено</p>
            <div class="modal-action">
                <label for="okModal" class="btn bg-blue-600 hover:bg-blue-700 text-white">Ок</label>
            </div>
        </div>
    </div>

    <!-- ERROR MODAL -->
    <input type="checkbox" id="errModal" class="modal-toggle"/>
    <div class="modal" role="dialog">
        <div class="modal-box bg-white border border-gray-200 rounded-xl">
            <h3 class="font-bold text-lg text-red-600">Ошибка</h3>
            <p id="errText" class="py-4 text-gray-700">Ошибка</p>
            <div class="modal-action">
                <label for="errModal" class="btn bg-blue-600 hover:bg-blue-700 text-white">Ок</label>
            </div>
        </div>
    </div>

    <script>
        function openOk(msg) {
            document.getElementById('okText').textContent = msg || 'OK';
            document.getElementById('okModal').checked = true;
        }

        function openErr(msg) {
            document.getElementById('errText').textContent = msg || 'Ошибка';
            document.getElementById('errModal').checked = true;
        }

        for (const btn of document.querySelectorAll('.confirm')) {
            btn.addEventListener('click', () => {
                const id = btn.dataset.pendingId;
                const fd = new FormData();
                fd.append('company_finances_id', id);

                fetch('/courier/confirm', {
                    method: 'POST',
                    body: fd,
                    credentials: 'same-origin'
                })
                    .then(res => res.json())
                    .then(json => {
                        if (json.status === 'ok') location.reload();
                    })
                    .catch(e => openErr(e?.message || 'Ошибка сети'));
            });
        }
    </script>
{% endblock %}
