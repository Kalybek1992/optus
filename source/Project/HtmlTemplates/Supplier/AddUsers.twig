{% extends './Navbar/Navbar.twig' %}

{% block content %}
    {% include './Breadcrumb/AddUsers.twig' %}

    <!-- Модалки -->
    <dialog id="statusModal" class="modal">
        <div class="modal-box text-center">
            <h3 id="statusTitle" class="text-lg font-bold"></h3>
            <p id="statusText" class="py-4"></p>

            <div class="modal-action">
                <form method="dialog">
                    <a href="/supplier/addUserPage"
                            id="closeModalBtn"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold
                           px-5 py-2 rounded-lg transition-colors duration-200">
                        ОК
                    </a>
                </form>
            </div>
        </div>
    </dialog>


    <!-- Контейнер формы -->
    <div class="w-full max-w-md p-8 bg-white rounded-2xl shadow-lg mx-auto mt-[50px]">
        <!-- Заголовок -->
        <div class="flex items-center justify-center mb-6">
            <svg class="w-10 h-10 text-emerald-600 mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a8 8 0 00-8 8h16a8 8 0 00-8-8z"/>
            </svg>
            <h2 class="text-3xl font-bold text-emerald-600">Добавить пользователя</h2>
        </div>

        <!-- Форма -->
        <form id="addUserForm" class="space-y-6" onsubmit="return false;">
            <!-- Имя -->
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                         class="w-5 h-5 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"/>
                    </svg>
                </span>
                <input type="text" id="name" name="name" placeholder="Имя пользователя" required
                       class="w-full pl-10 p-2 border rounded-md focus:ring-2 focus:ring-emerald-500 focus:outline-none"/>
            </div>

            <!-- Роль -->
            <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                       stroke="currentColor" class="w-5 h-5 text-gray-400">
                      <path stroke-linecap="round" stroke-linejoin="round"
                            d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z"/>
                  </svg>
                </span>
                <select id="role" name="role" required
                        class="w-full pl-10 p-2 border rounded-md bg-white focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    <option value="">Выберите роль</option>
                    <option value="manager">Менеджер</option>
                    <option value="client">Клиент</option>
                </select>
            </div>

            <!-- Процент (показывается только для клиента) -->
            <div id="percentageWrapper" class="relative hidden">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                      stroke="currentColor" class="w-5 h-5 text-gray-400">
                      <path stroke-linecap="round" stroke-linejoin="round"
                            d="m9 14.25 6-6m4.5-3.493V21.75l-3.75-1.5-3.75 1.5-3.75-1.5-3.75 1.5V4.757c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0c1.1.128 1.907 1.077 1.907 2.185ZM9.75 9h.008v.008H9.75V9Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm4.125 4.5h.008v.008h-.008V13.5Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"/>
                 </svg>

                </span>
                <input type="number" id="percentage" name="percent" placeholder="Процент (0 — 100)"
                       step="0.01" min="0" max="100"
                       class="w-full pl-10 p-2 border rounded-md focus:ring-2 focus:ring-emerald-500 focus:outline-none"/>
            </div>

            <!-- Ставки менеджера по кэшу и транзиту -->
            <div id="managerWrapper" class="relative hidden">

                <!-- Тема для transit-rate -->
                <div class="text-black font-semibold mb-1">Ставка транзит</div>
                <input type="number" id="transit-rate" name="transit_rate" placeholder="От 0,01 до 0,99"
                       step="0.01" min="0.01" max="0.99"
                       class="w-full pl-10 p-2 border rounded-md focus:ring-2 focus:ring-emerald-500 focus:outline-none mb-4"/>

                <!-- Тема для cash-bet -->
                <div class="text-black font-semibold mb-1">Ставка кеш</div>
                <input type="number" id="cash-bet" name="cash_bet" placeholder="От 0,01 до 0,99"
                       step="0.01" min="0.01" max="0.99"
                       class="w-full pl-10 p-2 border rounded-md focus:ring-2 focus:ring-emerald-500 focus:outline-none"/>
            </div>


            <!-- Кнопка -->
            <button id="submitUserBtn"
                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-200 text-center flex items-center justify-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" stroke-width="2"
                     viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                Создать пользователя
            </button>
        </form>
    </div>

    <script>
        const modal = document.getElementById('statusModal');
        const modalTitle = document.getElementById('statusTitle');
        const modalText = document.getElementById('statusText');
        const closeModalBtn = document.getElementById('closeModalBtn');

        const showModal = (title, text, success = false) => {
            modalTitle.textContent = title;
            modalText.textContent = text;
            modalTitle.className = success
                ? 'text-lg font-bold text-emerald-600'
                : 'text-lg font-bold text-red-600';
            try {
                modal.showModal();
            } catch (e) {
                alert(title + "\n\n" + text);
            }
        };

        function inputErrorProhibited() {

            // Процент (0.01 – 99)
            const percentageInput = document.getElementById('percentage');
            if (percentageInput) {
                percentageInput.addEventListener('input', () => {
                    let value = parseFloat(percentageInput.value);

                    if (isNaN(value)) {
                        percentageInput.value = '';
                        return;
                    }

                    if (value < 0.01) percentageInput.value = 0.01;
                    if (value > 99) percentageInput.value = 99;
                });
            }

            // Transit rate (0.01 – 0.99)
            const transitInput = document.getElementById('transit-rate');
            if (transitInput) {
                transitInput.addEventListener('input', () => {
                    let value = parseFloat(transitInput.value);

                    if (isNaN(value)) {
                        transitInput.value = '';
                    }
                });
            }

            // Cash bet (0.01 – 0.99)
            const cashInput = document.getElementById('cash-bet');
            if (cashInput) {
                cashInput.addEventListener('input', () => {
                    let value = parseFloat(cashInput.value);

                    if (isNaN(value)) {
                        cashInput.value = '';
                    }
                });
            }

        }


        function openPercentage() {
            const percentageWrapper = document.getElementById('percentageWrapper');
            const percentageInput = document.getElementById('percentage');

            percentageWrapper.classList.remove('hidden');
            percentageInput.setAttribute('aria-required', 'true');
        }

        function closePercentage() {
            const percentageWrapper = document.getElementById('percentageWrapper');
            const percentageInput = document.getElementById('percentage');
            percentageWrapper.classList.add('hidden');

            percentageInput.removeAttribute('aria-required');
            percentageInput.value = '';
        }

        const roleSelect = document.getElementById('role');
        roleSelect.selectedIndex = 0;

        function openTransitandCashManager() {
            const managerWrapper = document.getElementById('managerWrapper');
            const transitRateInput = document.getElementById('transit-rate');
            const cashBetInput = document.getElementById('cash-bet');

            managerWrapper.classList.remove('hidden');

            transitRateInput.setAttribute('aria-required', 'true');
            cashBetInput.setAttribute('aria-required', 'true');
        }

        function closeTransitandCashManager() {
            const managerWrapper = document.getElementById('managerWrapper');
            const transitRateInput = document.getElementById('transit-rate');
            const cashbetInput = document.getElementById('cash-bet');

            managerWrapper.classList.add('hidden');

            transitRateInput.removeAttribute('aria-required');
            transitRateInput.value = '';

            cashbetInput.removeAttribute('aria-required');
            cashbetInput.value = '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('addUserForm');
            const submitBtn = document.getElementById('submitUserBtn');
            const roleSelect = document.getElementById('role');


            // Показывать/скрывать поле процента
            const updatePercentageVisibility = () => {
                const role = roleSelect.value;
                if (role === 'client') {
                    openPercentage()
                    closeTransitandCashManager()
                }else if(role === 'manager') {
                    closePercentage()
                    openTransitandCashManager()
                }else {
                    closeTransitandCashManager()
                    closePercentage()
                }
                inputErrorProhibited()
            };

            roleSelect.addEventListener('change', updatePercentageVisibility);

            submitBtn.addEventListener('click', async () => {
                const name = document.getElementById('name').value.trim();
                const role = roleSelect.value;

                const percentVal = document.getElementById('percentage').value.trim();
                const transitRateVal = document.getElementById('transit-rate').value.trim();
                const cashBetVal = document.getElementById('cash-bet').value.trim();

                // Базовая проверка
                if (!name || !role) {
                    showModal('Ошибка!', 'Укажите имя и выберите роль!');
                    return;
                }

                const body = { name, role };

                // ===== CLIENT =====
                if (role === 'client') {

                    // percent обязателен
                    if (!percentVal) {
                        showModal('Ошибка!', 'Для клиента обязательно укажите процент!');
                        return;
                    }

                    const percent = Number(percentVal);
                    if (Number.isNaN(percent) || percent <= 0 || percent > 100) {
                        showModal('Ошибка!', 'Процент должен быть от 0.01 до 100.');
                        return;
                    }

                    body.percent = percent;

                    // transit-rate (если введён)
                    if (transitRateVal !== '') {
                        const transitRate = Number(transitRateVal);
                        if (Number.isNaN(transitRate) || transitRate < 0.01 || transitRate > 0.99) {
                            showModal('Ошибка!', 'Transit rate должен быть от 0.01 до 0.99.');
                            return;
                        }
                        body.transit_rate = transitRate;
                    }

                    // cash-bet (если введён)
                    if (cashBetVal !== '') {
                        const cashBet = Number(cashBetVal);
                        if (Number.isNaN(cashBet) || cashBet < 0.01 || cashBet > 0.99) {
                            showModal('Ошибка!', 'Cash bet должен быть от 0.01 до 0.99.');
                            return;
                        }
                        body.cash_bet = cashBet;
                    }
                }

                // ===== MANAGER =====
                if (role === 'manager') {
                    // percent (если введён — проверяем)
                    if (percentVal !== '') {
                        const percent = Number(percentVal);
                        if (Number.isNaN(percent) || percent <= 0 || percent > 100) {
                            showModal('Ошибка!', 'Процент должен быть от 0.01 до 100.');
                            return;
                        }
                        body.percent = percent;
                    }

                    function formatFloat(value) {
                        return Number(value).toFixed(2);
                    }

                    // transit-rate
                    if (transitRateVal !== '') {
                        const transitRateNum = Number(transitRateVal.replace(',', '.'));
                        if (Number.isNaN(transitRateNum) || transitRateNum < 0.01 || transitRateNum > 0.99) {
                            showModal('Ошибка!', 'Transit rate должен быть от 0.01 до 0.99.');
                            return;
                        }
                        body.transit_rate = formatFloat(transitRateNum);
                    }

                    // cash-bet
                    if (cashBetVal !== '') {
                        const cashBetNum = Number(cashBetVal.replace(',', '.'));
                        if (Number.isNaN(cashBetNum) || cashBetNum < 0.01 || cashBetNum > 0.99) {
                            showModal('Ошибка!', 'Cash bet должен быть от 0.01 до 0.99.');
                            return;
                        }
                        body.cash_bet = formatFloat(cashBetNum);
                    }

                }

                // ===== ОТПРАВКА =====
                const result = await postDataRes('/supplier/addUser', body);

                if (result.success) {
                    showModal('Успех!', 'Пользователь успешно добавлен!', true);
                } else {
                    form.reset();
                    showModal('Ошибка!', result.message || 'Не удалось добавить пользователя!');
                }
            });


            closeModalBtn.addEventListener('click', () => {
                try { modal.close(); } catch (e) {}
            });

            updatePercentageVisibility();
        });
    </script>

{% endblock %}
