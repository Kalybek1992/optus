{% extends './Navbar/Navbar.twig' %}

{% block content %}
    <div class="max-w-9xl mx-auto px-[60px] py-8 space-y-10">
        <!-- Заголовок -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Список планов администратора</h1>
            <p class="text-gray-500 text-sm mb-2">Просмотр всех запланированных задач</p>
        </div>

        <div class="flex flex-col md:flex-row md:items-center gap-4 p-4 mb-5">
            <!-- Селектор компании -->
            <div class="flex items-center w-full md:w-auto gap-2">
                <span class="text-sm font-medium text-blue-600">Компания-</span>
                <select id="company_select"
                        class="w-full md:w-[14rem] h-[44px] px-3 bg-white border border-blue-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 uppercase focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition">
                    <option value="">Выберите компанию</option>
                    {% for companie in legal_entitie %}
                        <option value="{{ companie.id }}">{{ companie.company_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Дата "от" -->
            <div class="flex items-center w-full md:w-auto gap-2">
                <span class="text-sm font-medium text-blue-600">ОТ-</span>
                <input type="text"
                       id="datepicker_from"
                       placeholder="Дата начала"
                       autocomplete="off"
                       class="w-full md:w-[12rem] h-[44px] px-3 bg-white border border-blue-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 uppercase focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition"/>
            </div>

            <!-- Дата "до" -->
            <div class="flex items-center w-full md:w-auto gap-2">
                <span class="text-sm font-medium text-blue-600">ДО-</span>
                <input type="text"
                       id="datepicker_to"
                       placeholder="Дата окончания"
                       autocomplete="off"
                       class="w-full md:w-[12rem] h-[44px] px-3 bg-white border border-blue-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 uppercase focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition"/>
            </div>

            <!-- Кнопка "Искать" -->
            <div class="w-full md:w-auto">
                <button id="searchFilters" type="submit"
                        class="w-full md:w-auto h-[44px] px-6 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg shadow-sm transition">
                    Поиск с фильтром
                </button>
            </div>
        </div>

        <!-- Заголовок темы таблицы -->
        <div class="text-center text-sm font-semibold text-gray-700">
            Список планов администратора с {{ date_from ?? '--.--.----' }} по {{ date_to ?? '--.--.----' }}
            <div class="mx-auto w-1/2 border-t border-gray-300 mt-7 mb-7"></div>
        </div>

        {% if plans is not empty %}
            <div class="bg-white shadow-sm rounded-2xl p-4 sm:p-6 border border-gray-100 mt-8">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs sm:text-sm text-left border-t border-gray-200 table-auto">
                        <thead class="bg-gray-50 text-gray-700">
                        <tr class="border-b">
                            <th class="py-2 px-2 sm:px-4 font-medium">Дата (день.месяц)</th>
                            <th class="py-2 px-2 sm:px-4 font-medium">Название плана</th>
                            <th class="py-2 px-2 sm:px-4 font-medium">Комментарий</th>
                            <th class="py-2 px-2 sm:px-4 font-medium">Тип повторения</th>
                            <th class="py-2 px-2 sm:px-4 font-medium">Компания</th>
                            <th class="py-2 px-2 sm:px-4 font-medium text-right text-blue-700">Сумма (₽)</th>
                            <th class="py-2 px-2 sm:px-4 font-medium text-right text-amber-600">Оплачено (₽)</th>
                            <th class="py-2 px-2 sm:px-4 font-medium text-center text-gray-700">Действия</th>
                        </tr>
                        </thead>

                        <tbody class="text-gray-700">
                        {% for item in plans %}
                            <tr class="hover:bg-gray-50 transition align-top flex flex-col sm:table-row mb-2 sm:mb-0">
                                <td class="py-2 px-2 sm:px-4">
                                    {{ '%02d.%02d'|format(item.day, item.month) }} {{ item.weekday }}
                                </td>

                                <td class="py-2 px-2 sm:px-4 font-semibold text-gray-800">
                                    {{ item.plan_name }}
                                </td>

                                <td class="py-2 px-2 sm:px-4">
                                    {{ item.comment }}
                                </td>

                                <td class="py-2 px-2 sm:px-4 text-center">
                                    {% if item.repeat_type == 'none' %}
                                        <span class="text-gray-500">Не повторяется</span>
                                    {% elseif item.repeat_type == 'weekly' %}
                                        <span class="text-blue-600 font-medium">Каждую неделю</span>
                                    {% elseif item.repeat_type == 'monthly' %}
                                        <span class="text-purple-600 font-medium">Каждый месяц</span>
                                    {% endif %}
                                </td>

                                <td class="py-2 px-2 sm:px-4">
                                    {% if item.company_name %}
                                        {{ item.company_name }}
                                    {% else %}
                                        <span class="text-gray-400">—</span>
                                    {% endif %}
                                </td>

                                <td class="py-2 px-2 sm:px-4 font-semibold text-blue-700 text-right">
                                    {{ item.amount|number_format(0, ',', ' ') }} ₽
                                </td>

                                <td class="py-2 px-2 sm:px-4 font-semibold text-amber-600 text-right">
                                    {{ item.paid|default(0)|number_format(0, ',', ' ') }} ₽
                                </td>

                                <!-- Кнопки действий -->
                                <td class="py-2 px-2 sm:px-4 text-center">
                                    <div class="flex justify-center gap-2">
                                        <!-- Оплатить -->
                                        <button
                                                class="paid-btn border border-blue-600 text-blue-600 p-[10px] rounded-lg hover:bg-blue-600 hover:text-white transition"
                                                data-id="{{ item.id }}"
                                                data-plan-name="{{ item.plan_name }}"
                                                data-amount="{{ item.amount }}"
                                                data-paid="{{ item.paid }}"
                                                data-repeat-type="{{ item.repeat_type }}"
                                                data-company-name="{{ item.company_name|default('—') }}"
                                                data-date="{{ '%02d.%02d'|format(item.day, item.month) }} {{ item.weekday }}"
                                                data-comment="{{ item.comment }}"
                                                data-paid-at="{{ item.paid >= item.amount and item.repeat_type == 'none' ? '1' : '0' }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                 stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                      d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h.008v.008H18V10.5Zm-12 0h.008v.008H6V10.5Z"/>
                                            </svg>
                                        </button>


                                        <!-- Редактировать -->
                                        <button
                                                class="edit-btn border border-orange-500 text-orange-500 p-[10px] rounded-lg hover:bg-orange-500 hover:text-white transition"
                                                data-id="{{ item.id }}"
                                                data-plan-name="{{ item.plan_name }}"
                                                data-amount="{{ item.amount }}"
                                                data-paid="{{ item.paid }}"
                                                data-repeat-type="{{ item.repeat_type }}"
                                                data-company-name="{{ item.company_name|default('—') }}"
                                                data-date="{{ '%02d.%02d'|format(item.day, item.month) }} {{ item.weekday }}"
                                                data-comment="{{ item.comment }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                 stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                      d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"/>
                                            </svg>
                                        </button>

                                        <!-- Удалить -->
                                        <button
                                                class="delete-btn border border-red-600 text-red-600 p-[10px] rounded-lg hover:bg-red-600 hover:text-white transition"
                                                data-id="{{ item.id }}"
                                                data-plan-name="{{ item.plan_name }}"
                                                data-amount="{{ item.amount }}"
                                                data-repeat-type="{{ item.repeat_type }}"
                                                data-company-name="{{ item.company_name|default('—') }}"
                                                data-date="{{ '%02d.%02d'|format(item.day, item.month) }} {{ item.weekday }}"
                                                data-comment="{{ item.comment }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                 stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                      d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"/>
                                            </svg>
                                        </button>

                                        <!-- Статус цветом -->
                                        <div class="p-[10px] rounded-lg border border-gray-100 flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                 stroke-width="1.5"
                                                 stroke="{% if item.status_color == 'red' %}#FF3B30{% elseif item.status_color == 'yellow' %}#FFD60A{% elseif item.status_color == 'green' %}#0A84FF{% else %}gray{% endif %}"
                                                 class="size-6">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                      d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"/>
                                            </svg>
                                        </div>
                                    </div>
                                </td>

                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% else %}
            <div class="bg-white shadow-sm rounded-2xl p-6 text-center text-gray-600 border border-gray-100 mt-8">
                <h2 class="text-xl font-semibold mb-2">Данные не найдены</h2>
                <p class="text-sm text-gray-500">Пока нет запланированных задач.</p>
            </div>
        {% endif %}
    </div>

    <div class="flex items-center justify-center py-6">
        {% include './Pagination/Pagination.twig' %}
    </div>


    <!-- Модалки ошибок и успеха -->
    <dialog id="errorModal" class="modal">
        <div class="modal-box">
            <h3 class="text-lg font-bold">Ошибка!</h3>
            <p id="errorText" class="py-4"></p>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Закрыть</button>
                </form>
            </div>
        </div>
    </dialog>


    <!-- Модальное окно удаление  -->
    <input type="checkbox" id="confirm_modal_delete" class="modal-toggle"/>
    <div class="modal" role="dialog">
        <div class="modal-box max-w-md">
            <h1 class="text-lg font-bold text-gray-800 mb-4">Подтвердить его удаление</h1>

            <div class="space-y-4">
                <!-- Дата -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalDateInput">Дата оплаты:</label>
                    <input type="text" id="modalDateInput"
                           class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                           readonly>
                </div>

                <!-- Компания -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalCompanyInput">Компания:</label>
                    <input type="text" id="modalCompanyInput"
                           class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                           readonly>
                </div>

                <!-- Название плана -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalPlanNameInput">Название:</label>
                    <input type="text" id="modalPlanNameInput"
                           class="w-full max-w-sm px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                           readonly>
                </div>

                <!-- Сумма -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalAmountInput">Сумма:</label>
                    <input type="text" id="modalAmountInput"
                           class="w-40 px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                           readonly>
                </div>

                <!-- Выбор повторения -->
                <div class="mt-6" x-data>
                    <!-- Повтор уведомлений -->
                    <span class="font-semibold text-gray-700 mb-2 block text-sm">Повтор уведомлений:</span>
                    <div class="flex flex-row gap-4 items-center">
                        <!-- Не повторять -->
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="repeatType" value="none"
                                   class="checkbox checkbox-md border border-blue-300 focus:border-blue-500 checked:bg-blue-600 checked:border-blue-600 checked:text-white"
                                   @click="document.querySelectorAll('input[name=repeatType]').forEach(el => { if(el !== $el) el.checked = false })"
                                   checked/>
                            <span class="text-gray-800 text-xs">Не повторять</span>
                        </label>

                        <!-- Каждую неделю -->
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="repeatType" value="weekly"
                                   class="checkbox checkbox-md border border-blue-300 focus:border-blue-500 checked:bg-blue-600 checked:border-blue-600 checked:text-white"
                                   @click="document.querySelectorAll('input[name=repeatType]').forEach(el => { if(el !== $el) el.checked = false })"/>
                            <span class="text-gray-800 text-xs">Каждую неделю</span>
                        </label>

                        <!-- Каждый месяц -->
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="repeatType" value="monthly"
                                   class="checkbox checkbox-md border border-blue-300 focus:border-blue-500 checked:bg-blue-600 checked:border-blue-600 checked:text-white"
                                   @click="document.querySelectorAll('input[name=repeatType]').forEach(el => { if(el !== $el) el.checked = false })"/>
                            <span class="text-gray-800 text-xs">Каждый месяц</span>
                        </label>
                    </div>

                    <div class="alert alert-info rounded-xl mt-3 text-white text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 stroke-current text-white"
                             fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z"/>
                        </svg>
                        <span>
                            Укажите, как часто будет повторяться уведомление. Например, каждую неделю или каждый месяц.
                        </span>
                    </div>
                </div>

                <!-- Комментарий -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalCommentInput">Комментарий:</label>
                    <textarea id="modalCommentInput"
                              class="w-full h-24 px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none resize-none"
                              readonly></textarea>
                </div>
            </div>

            <div class="modal-action mt-4">
                <button id="confirmSaveDelete"
                        class="btn bg-blue-600 hover:bg-blue-700 text-white border-none rounded-lg px-6">
                    Удалить!
                </button>
                <label for="confirm_modal_delete" class="btn btn-outline rounded-lg">Отменить</label>
            </div>
        </div>
    </div>

    <!-- Модальное окно оплаты -->
    <input type="checkbox" id="confirm_modal_paid" class="modal-toggle"/>
    <div class="modal" role="dialog">
        <div class="modal-box max-w-md">
            <h1 class="text-lg font-bold text-gray-800 mb-4">Подтвердить оплату</h1>

            <div class="space-y-4">
                <!-- Дата -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalDateInputPaid">Дата оплаты:</label>
                    <input type="text" id="modalDateInputPaid"
                           class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                           readonly>
                </div>

                <!-- Название плана -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalPlanNameInputPaid">Название:</label>
                    <input type="text" id="modalPlanNameInputPaid"
                           class="w-full max-w-sm px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                           readonly>
                </div>

                <!-- Суммы: общая и вводимая параллельно -->
                <div class="flex gap-4">
                    <!-- Общая сумма -->
                    <div class="flex flex-col flex-1">
                        <label class="font-semibold text-gray-700 mb-1" for="modalAmountInputPaid">Сумма:</label>
                        <input type="text" id="modalAmountInputPaid"
                               class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                               readonly>
                    </div>

                    <!-- Сумма для оплаты -->
                    <div class="flex flex-col flex-1">
                        <label class="font-semibold text-gray-700 mb-1" for="modalPaidInput">Оплата:</label>
                        <input type="number" id="modalPaidInput"
                               class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                               min="0">
                    </div>
                </div>


                <!-- Комментарий -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalCommentInputPaid">Комментарий:</label>
                    <textarea id="modalCommentInputPaid"
                              class="w-full h-24 px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none resize-none"
                              readonly></textarea>
                </div>
            </div>

            <div class="modal-action mt-4">
                <button id="confirmSavePaid"
                        class="btn bg-blue-600 hover:bg-blue-700 text-white border-none rounded-lg px-6">
                    Подтвердить оплату
                </button>
                <label for="confirm_modal_paid" class="btn btn-outline rounded-lg">Отменить</label>
            </div>
        </div>
    </div>


    <!-- Модальное окно редактирования -->
    <input type="checkbox" id="confirm_modal_edit" class="modal-toggle"/>
    <div class="modal" role="dialog">
        <div class="modal-box max-w-md">
            <h1 class="text-lg font-bold text-gray-800 mb-4">Редактировать план</h1>

            <div class="space-y-4">
                <!-- Дата -->
                <div class="flex items-center w-full md:w-auto gap-2">
                    <input
                            type="text"
                            id="datepicker_from_edit"
                            placeholder="Дата"
                            autocomplete="off"
                            class="w-full md:w-[12rem] h-[44px] px-4 bg-white rounded-xl text-base text-gray-700 border border-blue-300 focus:border-blue-500 focus:outline-none transition-all duration-150"
                    />
                </div>

                <!-- Старая компания -->
                <div class="flex flex-col mb-4">
                    <label class="font-medium text-gray-700 mb-1">Старая компания</label>
                    <input type="text" id="modalOldCompanyEdit" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none" readonly>
                </div>
                <!-- Новый селект компании -->
                <div class="mb-4 relative w-full" x-data="{ open: false, selected: '' }">
                    <label class="block font-medium text-gray-700 mb-2">Выберите компанию</label>

                    <!-- Сам селект -->
                    <div @click="open = !open"
                         class="border border-blue-300 rounded-xl px-4 py-2 bg-white cursor-pointer w-full flex justify-between items-center">
                        <span x-text="selected || '— Не выбрано —'"></span>
                        <svg :class="{ 'rotate-180': open }" class="w-4 h-4 ml-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>

                    <!-- Выпадающий список -->
                    <ul x-show="open" @click.outside="open = false"
                        class="absolute z-10 left-0 mt-1 w-full max-h-60 overflow-y-auto border border-blue-300 rounded-xl bg-white shadow-md">
                        <!-- Дефолтный вариант -->
                        <li @click="selected=''; open=false; $refs.companyId.value=''"
                            class="px-4 py-2 hover:bg-blue-100 break-words whitespace-normal cursor-pointer">
                            — Не выбрано —
                        </li>

                        <!-- Остальные опшены -->
                        {% for item in legal_entitie %}
                            <li @click="selected='{{ item.company_name }}'; open=false; $refs.companyId.value='{{ item.id }}'"
                                class="px-4 py-2 hover:bg-blue-100 break-words whitespace-normal cursor-pointer">
                                {{ item.company_name }}
                            </li>
                        {% endfor %}

                        <input type="hidden" x-ref="companyId" id="company_id" value="">
                    </ul>
                </div>


                <!-- Название плана -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalPlanNameInputEdit">Название:</label>
                    <input type="text" id="modalPlanNameInputEdit"
                           class="w-full max-w-sm px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                           placeholder="Название плана">
                </div>

                <!-- Сумма -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalAmountInputEdit">Сумма:</label>
                    <input type="text" id="modalAmountInputEdit"
                           class="w-40 px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                           placeholder="Сумма">
                </div>

                <!-- Выбор повторения -->
                <div class="mt-6" x-data>
                    <!-- Повтор уведомлений -->
                    <span class="font-semibold text-gray-700 mb-2 block text-sm">Повтор уведомлений:</span>
                    <div class="flex flex-row gap-4 items-center">
                        <!-- Не повторять -->
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="repeatTypeEdit" value="none"
                                   class="checkbox checkbox-md border border-blue-300 focus:border-blue-500 checked:bg-blue-600 checked:border-blue-600 checked:text-white"
                                   @click="document.querySelectorAll('input[name=repeatTypeEdit]').forEach(el => { if(el !== $el) el.checked = false })"
                                   checked />
                            <span class="text-gray-800 text-xs">Не повторять</span>
                        </label>

                        <!-- Каждую неделю -->
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="repeatTypeEdit" value="weekly"
                                   class="checkbox checkbox-md border border-blue-300 focus:border-blue-500 checked:bg-blue-600 checked:border-blue-600 checked:text-white"
                                   @click="document.querySelectorAll('input[name=repeatTypeEdit]').forEach(el => { if(el !== $el) el.checked = false })" />
                            <span class="text-gray-800 text-xs">Каждую неделю</span>
                        </label>

                        <!-- Каждый месяц -->
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="repeatTypeEdit" value="monthly"
                                   class="checkbox checkbox-md border border-blue-300 focus:border-blue-500 checked:bg-blue-600 checked:border-blue-600 checked:text-white"
                                   @click="document.querySelectorAll('input[name=repeatTypeEdit]').forEach(el => { if(el !== $el) el.checked = false })" />
                            <span class="text-gray-800 text-xs">Каждый месяц</span>
                        </label>
                    </div>

                    <div class="alert alert-info rounded-xl mt-3 text-white text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 stroke-current text-white" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
                        </svg>
                        <span>
                            Укажите, как часто будет повторяться уведомление. Например, каждую неделю или каждый месяц.
                        </span>
                    </div>
                </div>

                <!-- Комментарий -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1" for="modalCommentInputEdit">Комментарий:</label>
                    <textarea id="modalCommentInputEdit"
                              class="w-full h-24 px-3 py-2 border border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none resize-none"
                              placeholder="Комментарий"></textarea>
                </div>
            </div>

            <div class="modal-action mt-4">
                <button id="confirmSaveEdit"
                        class="btn bg-blue-600 hover:bg-blue-700 text-white border-none rounded-lg px-6">
                    Сохранить
                </button>
                <label for="confirm_modal_edit" class="btn btn-outline rounded-lg">Отменить</label>
            </div>
        </div>
    </div>



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
    <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
    <script src="/assets/js/PostData.js?v=<?= time() ?>"></script>

    <script>

        const i18n = {
            previousMonth: 'Предыдущий',
            nextMonth: 'Следующий',
            months: ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'],
            weekdays: ['Воскресенье','Понедельник','Вторник','Среда','Четверг','Пятница','Суббота'],
            weekdaysShort: ['Вс','Пн','Вт','Ср','Чт','Пт','Сб']
        };

        // Создаём Pikaday для поля редактирования
        const pickerEdit = new Pikaday({
            field: document.getElementById('datepicker_from_edit'),
            format: 'DD.MM',
            i18n: i18n,
            firstDay: 1,
            toString(date) {
                if (!date) return '';
                const day = String(date.getDate()).padStart(2,'0');
                const month = String(date.getMonth() + 1).padStart(2,'0');
                const weekday = i18n.weekdays[date.getDay()];
                return `${weekday} ${day}.${month}`;
            },
            parse(str) {
                if (!str) return null;
                const parts = str.split(' ');
                if (parts.length < 2) return null;
                const [d, m] = parts[1].split('.');
                if (!d || !m) return null;
                const year = new Date().getFullYear();
                return new Date(year, parseInt(m, 10) - 1, parseInt(d, 10));
            },
            firstDay: 1,
            onDraw: function() {
                if (!this.el) return;
                const label = this.el.querySelector('.pika-label');
                if (label) {
                    label.textContent = label.textContent.replace(/\d{4}/, '').trim();
                }
            }
        });


        const pickerFrom = new Pikaday({
            field: document.getElementById('datepicker_from'),
            format: 'DD.MM.YYYY',
            firstDay: 1,
            i18n: {
                previousMonth: 'Предыдущий',
                nextMonth: 'Следующий',
                months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
                weekdays: ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'],
                weekdaysShort: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб']
            },
            toString(date, format) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            },
            parse(dateString, format) {
                const parts = dateString.split('.');
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                return new Date(year, month, day);
            }
        });

        const pickerTo = new Pikaday({
            field: document.getElementById('datepicker_to'),
            format: 'DD.MM.YYYY',
            firstDay: 1,
            i18n: {
                previousMonth: 'Предыдущий',
                nextMonth: 'Следующий',
                months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
                weekdays: ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'],
                weekdaysShort: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб']
            },
            toString(date, format) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            },
            parse(dateString, format) {
                const parts = dateString.split('.');
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                return new Date(year, month, day);
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            function showCornerModal(message) {
                const checkbox = document.getElementById('notifications');
                const txtModal = document.getElementById('notifications-txt');
                checkbox.checked = true;
                txtModal.innerHTML = message;

                setTimeout(() => {
                    checkbox.checked = false;
                }, 5000);
            }


            // -----------------------------------
            // Универсальная функция для ошибок
            // -----------------------------------
            const openErrorModal = (message) => {
                const errorModal = document.getElementById('errorModal');
                const errorText = document.getElementById('errorText');
                if (errorModal && errorText) {
                    errorText.textContent = message;
                    errorModal.showModal();
                }
            };


            document.getElementById('searchFilters').addEventListener('click', () => {
                const dateFrom = document.getElementById('datepicker_from');
                const dateTo = document.getElementById('datepicker_to');
                const companySelect = document.getElementById('company_select');

                if (!dateFrom.value && !dateTo.value && !companySelect.value) {
                    showCornerModal('Выберите фильтр');
                    return;
                }

                if (!dateFrom.value && dateTo.value) {
                    showCornerModal('Выберите начало даты!');
                    return;
                }

                // Берём текущий URL и параметры
                const currentUrl = new URL(window.location.href);
                const params = new URLSearchParams(currentUrl.search);

                if (dateFrom.value) params.set('date_from', dateFrom.value);
                if (dateTo.value) params.set('date_to', dateTo.value);
                if (companySelect.value) params.set('legal_id', companySelect.value);

                // Переход с новыми параметрами
                window.location.href = `${currentUrl.origin}${currentUrl.pathname}?${params.toString()}`;
            });


            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const data = {
                        id: btn.dataset.id,
                        plan_name: btn.dataset.planName,
                        amount: btn.dataset.amount,
                        repeat_type: btn.dataset.repeatType,
                        company_name: btn.dataset.companyName,
                        date: btn.dataset.date,
                        comment: btn.dataset.comment
                    };
                    openConfirmDeleteModal(data);
                });
            });

            function openConfirmDeleteModal(data) {
                // Открываем модальное окно
                document.getElementById('confirm_modal_delete').checked = true;

                // Заполняем инпуты
                document.getElementById('modalDateInput').value = data.date;
                document.getElementById('modalCompanyInput').value = data.company_name;
                document.getElementById('modalPlanNameInput').value = data.plan_name;
                document.getElementById('modalAmountInput').value = data.amount + ' ₽';
                document.getElementById('modalCommentInput').value = data.comment;

                // Устанавливаем чекбоксы
                document.querySelectorAll('input[name=repeatType]').forEach(el => {
                    el.checked = (el.value === data.repeat_type);
                    el.disabled = true; // нельзя переключать
                });

                // Прошиваем id в кнопку подтверждения
                const confirmBtn = document.getElementById('confirmSaveDelete');
                confirmBtn.dataset.taskId = data.id;
            }

            document.addEventListener('click', async (e) => {
                const confirmBtn = e.target.closest('#confirmSaveDelete'); // <-- исправлено
                if (!confirmBtn) return;

                const taskId = confirmBtn.dataset.taskId; // убедитесь, что data-task-id есть на кнопке
                if (!taskId) return;

                const payload = {task_id: taskId};
                const result = await postDataRes('/scheduler/deleteTask', payload);

                if (result.status === 'error' || result === 'error') {
                    document.getElementById('confirm_modal_delete').checked = false;
                    openErrorModal('Ошибка при удалении!');
                    return;
                }

                location.reload();
            });

            document.querySelectorAll('.paid-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Проверяем, не оплачено ли уже
                    const isPaid = btn.dataset.paidAt === '1';

                    if (isPaid) {
                        openErrorModal('Ошибка при оплате! Эта запись уже оплачена.');
                        return; // выходим, не открываем модалку
                    }

                    const data = {
                        id: btn.dataset.id,
                        plan_name: btn.dataset.planName,
                        amount: parseFloat(btn.dataset.amount),
                        paid: parseFloat(btn.dataset.paid || 0),
                        repeat_type: btn.dataset.repeatType,
                        company_name: btn.dataset.companyName,
                        date: btn.dataset.date,
                        comment: btn.dataset.comment
                    };

                    openConfirmPaidModal(data);
                });
            });


            function openConfirmPaidModal(data) {
                document.getElementById('confirm_modal_paid').checked = true;

                const remaining = data.amount - data.paid; // вычисляем остаток к оплате

                document.getElementById('modalDateInputPaid').value = data.date;
                document.getElementById('modalPlanNameInputPaid').value = data.plan_name;
                document.getElementById('modalAmountInputPaid').value = remaining + ' ₽'; // показываем остаток
                document.getElementById('modalPaidInput').value = remaining; // по умолчанию остаток
                document.getElementById('modalPaidInput').max = remaining; // ограничение
                document.getElementById('modalCommentInputPaid').value = data.comment;

                // Прошиваем id в кнопку подтверждения
                const confirmBtn = document.getElementById('confirmSavePaid');
                confirmBtn.dataset.taskId = data.id;
            }

            // Ограничение ввода суммы
            document.getElementById('modalPaidInput').addEventListener('input', function () {
                const max = parseFloat(this.max);
                if (parseFloat(this.value) > max) {
                    this.value = max;
                }
            });

            // Подтверждение оплаты
            document.addEventListener('click', async (e) => {
                const confirmBtn = e.target.closest('#confirmSavePaid');
                if (!confirmBtn) return;

                const taskId = confirmBtn.dataset.taskId;
                const paidAmount = parseFloat(document.getElementById('modalPaidInput').value);

                if (!taskId || !paidAmount) return;

                const payload = {task_id: taskId, amount: paidAmount};

                console.log(payload);
                const result = await postDataRes('/scheduler/payTask', payload);

                if (result.status === 'error' || result === 'error') {
                    document.getElementById('confirm_modal_paid').checked = false;
                    openErrorModal('Ошибка при оплате!');
                    return;
                }

                location.reload();
            });


            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const data = {
                        id: btn.dataset.id,
                        plan_name: btn.dataset.planName,
                        amount: btn.dataset.amount,
                        repeat_type: btn.dataset.repeatType,
                        company_name: btn.dataset.companyName,
                        date: btn.dataset.date,
                        comment: btn.dataset.comment
                    };
                    openEditModal(data);
                });
            });

            function openEditModal(data) {
                document.getElementById('confirm_modal_edit').checked = true;

                // Устанавливаем дату
                const dateInput = document.getElementById('datepicker_from_edit');
                if (dateInput && data.date) {
                    // data.date приходит как "12.11 Среда"
                    const parts = data.date.split(' ');
                    if (parts.length >= 2) {
                        const [day, month] = parts[0].split('.');
                        const now = new Date();
                        const dateObj = new Date(now.getFullYear(), parseInt(month, 10) - 1, parseInt(day, 10));

                        pickerEdit.setDate(dateObj, true); // ✅ Устанавливаем в сам Pikaday
                    }
                }

                // Остальные поля
                document.getElementById('modalPlanNameInputEdit').value = data.plan_name;
                document.getElementById('modalAmountInputEdit').value = data.amount;
                document.getElementById('modalCommentInputEdit').value = data.comment;

                // Чекбоксы
                document.querySelectorAll('input[name=repeatTypeEdit]').forEach(el => {
                    el.checked = (el.value === data.repeat_type);
                });

                // Старая компания
                const oldCompanyInput = document.getElementById('modalOldCompanyEdit');
                if (oldCompanyInput) {
                    oldCompanyInput.value = data.company_name || '';
                }

                // id задачи
                const confirmBtn = document.getElementById('confirmSaveEdit');
                confirmBtn.dataset.taskId = data.id;
            }


            // Дальше можно повесить обработчик сохранения
            document.addEventListener('click', async (e) => {
                const confirmBtn = e.target.closest('#confirmSaveEdit');
                if (!confirmBtn) return;

                const taskId = confirmBtn.dataset.taskId;
                if (!taskId) return;

                // Берём дату из поля
                let date = document.getElementById('datepicker_from_edit').value.trim();
                const plan_name = document.getElementById('modalPlanNameInputEdit').value.trim();
                const amount = parseFloat(document.getElementById('modalAmountInputEdit').value);
                const comment = document.getElementById('modalCommentInputEdit').value.trim();
                const companyId = document.getElementById('company_id').value.trim();
                const checkedRepeat = document.querySelector('input[name="repeatTypeEdit"]:checked');
                const repeatType = checkedRepeat ? checkedRepeat.value : 'none';

                // --- Извлечение дня недели ---
                const weekdayMatch = date.match(/^[а-яА-ЯёЁ]+/);
                const weekdayName = weekdayMatch ? weekdayMatch[0].toLowerCase() : null;

                const weekdays = {
                    'понедельник': 1,
                    'вторник': 2,
                    'среда': 3,
                    'четверг': 4,
                    'пятница': 5,
                    'суббота': 6,
                    'воскресенье': 7
                };

                const weekdayNumber = weekdayName ? weekdays[weekdayName] || null : null;

                // Убираем день недели из даты ("Понедельник 11.11" → "11.11")
                date = date.replace(/^[а-яА-ЯёЁ]+[,\s]+/i, '');

                // Собираем данные
                const payload = {
                    task_id: taskId,
                    date,
                    weekday: weekdayNumber,
                    plan_name,
                    amount,
                    comment,
                    legal_id: companyId || '',
                    repeat_type: repeatType
                };

                console.log(payload);

                const result = await postDataRes('/scheduler/editTask', payload);

                console.log(result);



                if (result.status === 'error' || result === 'error') {
                    document.getElementById('confirm_modal_paid').checked = false;
                    openErrorModal('Ошибка редактирование!');
                    return;
                }

                location.reload();
            });
        });


    </script>

{% endblock %}