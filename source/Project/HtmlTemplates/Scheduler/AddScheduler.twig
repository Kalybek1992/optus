{% extends './Navbar/Navbar.twig' %}

{% block content %}
    {% include './Breadcrumb/AddScheduler.twig' %}

    <div class="max-w-[880px] mx-auto p-4 sm:p-6">
        <div class="bg-white shadow rounded-2xl border border-gray-100">
            <div class="p-5 sm:p-8">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6 text-gray-800">
                    Создать платёжный план
                </h2>

                <form id="planForm" class="space-y-5 sm:space-y-6" novalidate>

                    <!-- Дата -->
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-3 w-full">
                        <input
                                type="text"
                                id="datepicker_from"
                                placeholder="Дата"
                                autocomplete="off"
                                class="w-full md:w-[12rem] h-[44px] px-4 bg-white rounded-xl text-base text-gray-700 border border-blue-300 focus:border-blue-500 focus:outline-none transition-all duration-150"
                        />
                    </div>

                    <!-- Выбор компании -->
                    <div class="relative w-full" x-data="{ open: false, selected: '' }">
                        <label class="block font-medium text-gray-700 mb-2 text-sm sm:text-base">Выберите
                            компанию</label>

                        <!-- Сам селект -->
                        <div @click="open = !open"
                             class="border border-blue-300 rounded-xl px-4 py-2 bg-white cursor-pointer w-full flex justify-between items-center">
                            <span x-text="selected || '— Не выбрано —'"></span>

                            <svg :class="{ 'rotate-180': open }"
                                 class="w-4 h-4 ml-2 transition-transform"
                                 fill="none"
                                 stroke="currentColor"
                                 viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>

                        <!-- Выпадающий список -->
                        <ul x-show="open"
                            @click.outside="open = false"
                            class="absolute z-10 left-0 mt-1 w-full max-h-60 overflow-y-auto border border-blue-300 rounded-xl bg-white shadow-md text-sm sm:text-base">
                            <li @click="selected=''; open=false"
                                class="px-4 py-2 hover:bg-blue-100 cursor-pointer break-words whitespace-normal">
                                — Не выбрано —
                            </li>

                            {% for item in legal_entitie %}
                                <li @click="selected='{{ item.company_name }}'; open=false; $refs.companyId.value='{{ item.id }}'"
                                    class="px-4 py-2 hover:bg-blue-100 cursor-pointer break-words whitespace-normal">
                                    {{ item.company_name }}
                                </li>
                            {% endfor %}

                            <input type="hidden" x-ref="companyId" id="company_id" value="">
                        </ul>
                    </div>

                    <!-- Название плана -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium text-gray-700">Название плана</span>
                        </label>
                        <input
                                name="plan_name"
                                type="text"
                                id="plan_name"
                                placeholder="Введите название плана"
                                class="input w-full border border-blue-300 focus:border-blue-500 focus:outline-none px-4 py-2 rounded-xl transition-all duration-150"
                        />
                    </div>

                    <!-- Сумма -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium text-gray-700">Сумма</span>
                        </label>
                        <input
                                name="amount"
                                id="amount"
                                type="number"
                                step="0.01"
                                placeholder="Введите сумму"
                                class="input w-full border border-blue-300 focus:border-blue-500 focus:outline-none px-4 py-2 rounded-xl transition-all duration-150"
                        />
                    </div>

                    <!-- Комментарий -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium text-gray-700">Комментарий</span>
                        </label>
                        <textarea
                                name="comment"
                                id="comment"
                                rows="4"
                                placeholder="Введите комментарий..."
                                class="textarea w-full border border-blue-300 focus:border-blue-500 focus:outline-none px-4 py-3 rounded-xl transition-all duration-150"
                        ></textarea>
                    </div>

                    <!-- Кнопка сохранить -->
                    <div class="flex justify-end pt-1 sm:pt-2">
                        <button id="saveButton" type="button"
                                class="btn bg-blue-600 hover:bg-blue-700 text-white border-none rounded-lg px-6 h-[42px] sm:h-[44px] w-full sm:w-auto">
                            Сохранить
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения -->
    <input type="checkbox" id="confirm_modal" class="modal-toggle"/>
    <div class="modal" role="dialog">
        <div class="modal-box w-full max-w-full sm:max-w-md p-4 sm:p-6 rounded-xl">
            <h1 class="text-base sm:text-lg font-bold text-gray-800 mb-4 text-center sm:text-left">
                Подтверждение сохранения
            </h1>

            <div class="space-y-4">
                <!-- Дата -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1 text-xs sm:text-sm" for="modalDateInput">Дата:</label>
                    <input type="text"
                           id="modalDateInput"
                           disabled
                           autocomplete="off"
                           class="w-full h-10 sm:h-12 px-3 sm:px-4 bg-gray-50 rounded-lg shadow-sm
                              text-xs sm:text-base font-semibold text-gray-700 uppercase
                              border border-blue-300 cursor-default"
                           readonly>
                </div>

                <!-- Компания -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1 text-xs sm:text-sm" for="modalCompanyInput">Компания:</label>
                    <input type="text" id="modalCompanyInput"
                           class="w-full h-10 sm:h-12 px-3 sm:px-4 bg-gray-50 rounded-lg shadow-sm
                              border border-blue-300 cursor-default text-xs sm:text-base"
                           readonly>
                </div>

                <!-- Название плана -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1 text-xs sm:text-sm" for="modalPlanNameInput">Название:</label>
                    <input type="text" id="modalPlanNameInput"
                           class="w-full h-10 sm:h-12 px-3 sm:px-4 bg-gray-50 rounded-lg shadow-sm
                              border border-blue-300 cursor-default text-xs sm:text-base"
                           readonly>
                </div>

                <!-- Сумма -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1 text-xs sm:text-sm" for="modalAmountInput">Сумма:</label>
                    <input type="text" id="modalAmountInput"
                           class="w-full sm:w-40 h-10 sm:h-12 px-3 sm:px-4 bg-gray-50 rounded-lg shadow-sm
                              border border-blue-300 cursor-default text-xs sm:text-base"
                           readonly>
                </div>

                <!-- Выбор повторения -->
                <div class="mt-4 sm:mt-6" x-data>
                    <span class="font-semibold text-gray-700 mb-2 block text-xs sm:text-sm">Повтор уведомлений:</span>

                    <div class="flex flex-wrap gap-2 sm:gap-4 items-center">
                        <label class="flex items-center gap-2 cursor-pointer text-xs sm:text-sm">
                            <input type="checkbox" name="repeatType" value="none"
                                   class="checkbox checkbox-sm sm:checkbox-md border border-blue-300
                                      checked:bg-blue-600 checked:border-blue-600"
                                   @click="document.querySelectorAll('input[name=repeatType]').forEach(el => { if(el !== $el) el.checked = false })"
                                   checked/>
                            <span>Не повторять</span>
                        </label>

                        <label class="flex items-center gap-2 cursor-pointer text-xs sm:text-sm">
                            <input type="checkbox" name="repeatType" value="weekly"
                                   class="checkbox checkbox-sm sm:checkbox-md border border-blue-300
                                      checked:bg-blue-600 checked:border-blue-600"
                                   @click="document.querySelectorAll('input[name=repeatType]').forEach(el => { if(el !== $el) el.checked = false })"/>
                            <span>Каждую неделю</span>
                        </label>

                        <label class="flex items-center gap-2 cursor-pointer text-xs sm:text-sm">
                            <input type="checkbox" name="repeatType" value="monthly"
                                   class="checkbox checkbox-sm sm:checkbox-md border border-blue-300
                                      checked:bg-blue-600 checked:border-blue-600"
                                   @click="document.querySelectorAll('input[name=repeatType]').forEach(el => { if(el !== $el) el.checked = false })"/>
                            <span>Каждый месяц</span>
                        </label>
                    </div>

                    <div class="alert alert-info rounded-xl mt-3 text-white text-xs sm:text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-4 w-4 sm:h-5 sm:w-5 shrink-0 stroke-current text-white" fill="none"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z"/>
                        </svg>
                        <span>
                        Укажите, как часто будет повторяться уведомление.
                    </span>
                    </div>
                </div>

                <!-- Комментарий -->
                <div class="flex flex-col">
                    <label class="font-semibold text-gray-700 mb-1 text-xs sm:text-sm" for="modalCommentInput">Комментарий:</label>
                    <textarea id="modalCommentInput"
                              class="w-full h-20 sm:h-24 px-3 sm:px-4 py-2 bg-gray-50 rounded-lg shadow-sm
                                 border border-blue-300 cursor-default resize-none text-xs sm:text-base"
                              readonly></textarea>
                </div>
            </div>

            <!-- Кнопки -->
            <div class="modal-action mt-4 flex flex-col gap-2 sm:flex-row sm:justify-end pb-[60px]">
                <button id="confirmSave"
                        class="w-full sm:w-auto h-10 sm:h-12 px-4 sm:px-6 bg-blue-600 hover:bg-blue-700 text-white text-xs sm:text-sm font-semibold rounded-lg transition">
                    Подтвердить
                </button>

                <label for="confirm_modal"
                       class="w-full sm:w-auto h-10 sm:h-12 px-4 sm:px-6 btn btn-outline rounded-lg text-xs sm:text-sm transition">
                    Отменить
                </label>
            </div>
        </div>
    </div>

    <!-- Модальное окно ошибки -->
    <dialog id="errorEmail" class="modal">
        <div class="modal-box">
            <h3 class="text-lg font-bold">Ошибка!</h3>
            <p id="errorText" class="py-4"></p>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Закрыть</button>
                </form>
            </div>
        </div>
    </dialog>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
    <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>

    <script>
        // Настройка Pikaday только для выбора месяца
        const i18n = {
            previousMonth: 'Предыдущий',
            nextMonth: 'Следующий',
            months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
            weekdays: ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'],
            weekdaysShort: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб']
        };

        const pickerFrom = new Pikaday({
            field: document.getElementById('datepicker_from'),
            format: 'DD.MM', // внутренний формат
            i18n: i18n,
            toString(date) {
                if (!date) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const weekday = i18n.weekdays[date.getDay()]; // используем внешний i18n
                return `${weekday} ${day}.${month}`;
            },
            parse(str) {
                if (!str) return null;
                const parts = str.split(' ');
                if (parts.length < 2) return null;
                const [d, m] = parts[1].split('.');
                if (!d || !m) return null;
                const year = new Date().getFullYear();
                return new Date(year, parseInt(m, 10) - 1, parseInt(d, 10));
            },
            firstDay: 1,
            onDraw: function () {
                if (!this.el) return;
                const label = this.el.querySelector('.pika-label');
                if (label) {
                    label.textContent = label.textContent.replace(/\d{4}/, '').trim();
                }
            }
        });

        // Функция открытия ошибки
        const openErrorModal = (message) => {
            document.getElementById('errorText').innerText = message;
            document.getElementById('errorEmail').showModal();
        };


        // Обработчик кнопки "Сохранить"
        document.getElementById('saveButton').addEventListener('click', () => {
            const date = document.getElementById('datepicker_from').value.trim();
            const plan_name = document.getElementById('plan_name').value.trim();
            const amountRaw = document.getElementById('amount').value.trim();
            const comment = document.getElementById('comment').value.trim();

            // получаем компанию
            const companyName = document.querySelector('[x-data] span[x-text]').innerText.trim();
            const companyId = document.getElementById('company_id').value.trim();

            // проверяем обязательные поля (без компании!)
            if (!date || !plan_name || !amountRaw || !comment) {
                openErrorModal('Все поля должны быть заполнены!');
                return;
            }

            const amount = parseFloat(amountRaw);
            if (isNaN(amount) || amount <= 0) {
                openErrorModal('Сумма должна быть положительной и больше нуля!');
                return;
            }

            // заполняем модальное окно
            document.getElementById('modalDateInput').value = date;
            document.getElementById('modalPlanNameInput').value = plan_name;
            document.getElementById('modalAmountInput').value = amount;
            document.getElementById('modalCommentInput').value = comment;

            const companyBlock = document.querySelector('#modalCompanyInput')?.closest('div.flex');
            if (companyId && companyName && companyBlock) {
                document.getElementById('modalCompanyInput').value = companyName;
                companyBlock.style.display = 'flex';
            } else if (companyBlock) {
                companyBlock.style.display = 'none';
            }

            // открываем модалку
            document.getElementById('confirm_modal').checked = true;
        });

        // Обработчик кнопки "Подтвердить"
        document.getElementById('confirmSave').addEventListener('click', async () => {
            let date = document.getElementById('datepicker_from').value.trim();
            const plan_name = document.getElementById('plan_name').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const comment = document.getElementById('comment').value.trim();
            const companyId = document.getElementById('company_id').value.trim();

            const checkedRepeat = document.querySelector('input[name="repeatType"]:checked');
            const repeatType = checkedRepeat ? checkedRepeat.value : 'none';

            // Сначала извлекаем день недели (если есть)
            const weekdayMatch = date.match(/^[а-яА-ЯёЁ]+/);
            const weekdayName = weekdayMatch ? weekdayMatch[0].toLowerCase() : null;

            // Словарь для перевода дня недели в число
            const weekdays = {
                'понедельник': 1,
                'вторник': 2,
                'среда': 3,
                'четверг': 4,
                'пятница': 5,
                'суббота': 6,
                'воскресенье': 7
            };

            // Получаем числовое значение дня недели
            const weekdayNumber = weekdayName ? weekdays[weekdayName] || null : null;

            // Удаляем день недели из даты (например "Вторник 11.11" → "11.11")
            date = date.replace(/^[а-яА-ЯёЁ]+[,\s]+/i, '');

            if (!date || !plan_name || !comment || isNaN(amount) || amount <= 0) {
                document.getElementById('confirm_modal').checked = false;
                openErrorModal('Данные стали некорректными. Проверьте форму.');
                return;
            }

            const payload = {
                date,
                plan_name,
                amount,
                comment,
                legal_id: companyId || null,
                repeat_type: repeatType,
                weekday: weekdayNumber // добавляем день недели числом
            };

            const result = await postData('/scheduler/addNewScheduler', payload);

            if (result.status === 'error' && result.error === 'repeat_task') {
                document.getElementById('confirm_modal').checked = false;
                openErrorModal('Такой план уже существует с такими данными');
                return;
            }

            if (result === 'error' || !result.success) {
                document.getElementById('confirm_modal').checked = false;
                openErrorModal(result?.message || 'Ошибка при создании плана!');
                return;
            }

            location.reload();
        });
    </script>

{% endblock %}
