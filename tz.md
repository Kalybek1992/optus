### Техническое задание (ТЗ) и проектирование базы данных

### 0. Краткое описание
Мы создаем систему учета движения денежных средств (наличных и безналичных). В процессе задействованы разные роли - клиент, админ, поставщик (может быть и клиентом) курьер. 

1. Клиент - единая сущность, но может много юр. лиц (там разные рассчётные счета). Может иметь долг, а также мы перед ним можем иметь долг. Клиент всегда переводит деньги и платит ещё какой-то процент за услуги. Т.е. если клиенту задана цена 10% за услугу, то при переводе 100руб = 10руб - это его плата за услугу. Т.е. после перевода от него 100 рублей нам, то у нас перед ним долг 100 рублей. Любые долги могут закрываться частично! Это важный момент.

2. Поставщик. Может быть клиентом. Также единая сущность, которая может иметь много юр. лиц. Тоже может иметь долг, как мы перед ним. Поставщику уже мы платим % за услугу, т.е. переводя ему деньги, он нам должен за вычетом установленного у него процента (плата за услуги). У каждого поставщика также может быть свой процент.
   
3. Курьер забирает деньги у поставщика, и развозит клиентам (он отмечает в системе у кого сколько забрал и кому сколько отдал, т.е. выбирает поставщиков и клиентов). Также у курьера свой баланс, т.е. когда он забрал, то его баланс пополнился, а когда отдал, то уменьшился. Также у курьера есть возможность создавать транзакции из своего баланса на различные платежи.

4. Админ. Может загружать файл-выписку из банка (пришлю отдельно). Из файла мы считываем данные, если видим неизвестный рассчётный счёт, то предлагаем привязать его к клиенту, поставщику, либо нам, либо создать нового клиента/поставщика. Также можно вручную создавать транзакции. Админ видит всё, все долги перед кем-то и кто должен нам (можно отдельную страницу под долги), сколько денег у курьера (под курьера тоже отдельную стр. можно), его транзакции и вообще все транзакции. Также нужно логгировать вообще каждое действие (можно в таблицу бд history (операция, кем, когда, старое значение, новое значение). Админ может записывать транзакции в различные расходы вроде налогов, аренды, непредвиденных расходов (это всё также при загрузке выписки). Также админ может создавать транзакции о снятии наличиных и указывать кто снял (курьер, например), вероятно получится номер карты как-то привязать, либо счёта, чтобы потом это автоматически тоже считывалось из выгрузки. Если снял курьер, то его баланс пополняется. Подробнее далее. 
Выписки будут в txt файлах. 

#### **1. Функциональные требования**
**Основные роли и их взаимодействия:**
- **Администратор**:
  - Загружает и обрабатывает выписки из банка.
  - Привязывает неопознанные счета к клиентам/поставщикам/нам/курьерам или создает новых.
  - Просматривает все транзакции, долги, балансы курьеров, логи.
  - Управляет ролями пользователей (клиенты, курьеры, поставщики).
  - Логгирует все действия в системе.
  - Может создавать транзакции вручную.
  - Может создавать/редактировать пользователей.

- **Клиент**:
  - Имеет несколько юридических лиц (расчетных счетов).
  - Может иметь долг перед системой (нами) или наоборот.
  - Видит свой баланс и историю транзакций.

- **Поставщик** (может быть и клиентом сразу):
  - Имеет несколько юридических лиц.
  - Получает деньги от системы (с учетом процента за услуги).
  - Может иметь долг перед системой или наоборот.

- **Курьер**:
  - Забирает деньги у поставщиков и раздает клиентам.
  - Управляет своим балансом (пополнение при получении денег, списание при передаче).
  - Создает транзакции для оплаты расходов (например, зарплата, налоги).

---

#### **2. База данных: сущности и связи**
**Основные таблицы:**
1. **Пользователи** (`users`):
   - `id`, `role` (admin, client, supplier, courier), `name`, `email`, `password`.
   - Связь: один ко многим с `clients`, `suppliers`, `couriers`.

2. **Клиенты** (`clients`):
   - `id`, `user_id`, `name`, `percentage` (процент, который клиент платит системе).
   - Связь: один ко многим с `legal_entities`.

3. **Поставщики** (`suppliers`):
   - `id`, `user_id`, `name`, `percentage` (процент, который система платит поставщику, но если он и клиент, то, наверное, нужно поле и для процента который он платит нам).
   - Связь: один ко многим с `legal_entities`.

4. **Юридические лица** (`legal_entities`):
   - `id`, `client_id/supplier_id` (внешний ключ), `name`, `inn`, `kpp`, `bank_account`, `bank_name`, `bic`. (не факт что нужны inn, kpp, bic - подумаем над этим в процессе).

5. **Банковские счета** (`bank_accounts`):
   - `id`, `legal_entity_id`, `account_number`, `balance`.

6. **Транзакции** (`transactions`):
   - `id`, `type` (приход/расход), `amount`, `date`, `description`, 
   - `from_account_id` (банк/курьер/поставщик), `to_account_id` (банк/курьер/клиент),
   - `courier_id` (если участвует курьер), `status` (обработана/не обработана).

7. **Долги** (`debts`):
   - `id`, `client_id/supplier_id`, `amount`, `status` (активный/погашенный).

8. **Баланс курьера** (`courier_balances`):
   - `id`, `courier_id`, `current_balance`, `last_update`.

9. **Логи** (`logs`):
   - `id`, `user_id`, `action` (создание/изменение/удаление/редактирование), `entity_type` (транзакция, долг и т.д.), 
   - `old_value`, `new_value`, `timestamp`.

---

#### **3. Взаимодействие с выпиской из банка**
**Процесс обработки:**
1. Администратор загружает файл выписки.
2. Система парсит данные:
   - Извлекает расчетные счета, суммы, назначения платежей.
3. Для неопознанных счетов:
   - Предлагает администратору привязать к существующему клиенту/поставщику/нам или создать нового.
4. Автоматически создает транзакции:
   - Для прихода: связывает с клиентом/поставщиком.
   - Для расхода: определяет тип (комиссия, налог, зарплата и т.д.).

**Пример данных из выписки:**
- Платеж от ООО "ВСМ-Авто" на сумму 44 280 руб. → привязывается к клиенту.
- Комиссия банка 290 руб. → тип расхода "Комиссия".

---

#### **4. Расчет процентов и долгов**
- **Для клиентов**:
  - При поступлении денег от клиента: `сумма_долга = сумма_платежа * (1 - процент_клиента)`.
  - Пример: клиент перевел 100 000 руб. с процентом 10% → долг системы перед клиентом = 90 000 руб.

- **Для поставщиков**:
  - При отправке денег поставщику: `сумма_долга = сумма_платежа * (1 - процент_поставщика)`.
  - Пример: система отправила 100 000 руб. поставщику с процентом 5% → долг поставщика перед системой = 95 000 руб.

---

#### **5. Интерфейс для курьера**
- **Функции**:
  - Ввод данных о забранных/переданных суммах.
  - Просмотр текущего баланса.
  - Создание транзакций для расходов (например, оплата аренды).

**Пример сценария:**
1. Курьер забрал 50 000 руб. у поставщика → баланс курьера +50 000.
2. Курьер передал 45 000 руб. клиенту → баланс курьера -45 000.
3. Оставшиеся 5 000 руб. курьер использовал для оплаты налогов → создана транзакция типа "Налог".

---

#### **6. Логгирование**
- Каждое действие (создание/изменение транзакции, привязка счета, изменение баланса) записывается в `logs`.
- Пример записи (лишь как пример в виде json, формат не важен, конечно же, главное что поля такие):
  ```json
  {
    "user_id": 1,
    "action": "update",
    "entity_type": "transaction",
    "old_value": "status: pending",
    "new_value": "status: processed",
    "timestamp": "2025-03-14 15:30:00"
  }
  ```
---

#### **8. Дополнительные требования**
- **Безопасность**: Роли RBAC (Role-Based Access Control) для ограничения доступа.
- **Интеграция с банком**: API для автоматической загрузки выписок.
- **Отчеты**: Генерация PDF/Excel по долгам, транзакциям, балансам.

---


### **Примерный проект базы данных**

#### **1. Основные таблицы**
| Таблица              | Поля и описание                                                                 |
|----------------------|---------------------------------------------------------------------------------|
| **users**            | `id`, `role` (admin/client/supplier/courier), `name`, `email`, `password`       |
| **clients**          | `id`, `user_id` (FK), `name`, `percentage` (процент клиента)                   |
| **suppliers**        | `id`, `user_id` (FK), `name`, `percentage` (процент поставщика)                |
| **couriers**         | `id`, `user_id` (FK), `name`                                                   |

---

#### **2. Юридические лица и счета**
| Таблица              | Поля и описание                                                                 |
|----------------------|---------------------------------------------------------------------------------|
| **legal_entities**   | `id`, `client_id/supplier_id` (FK), `name`, `inn`, `kpp`, `bank_account`, `bank_name`, `bic`, `correspondent_account` |
| **bank_accounts**    | `id`, `legal_entity_id` (FK), `account_number`, `balance` (текущий баланс)     |

---

#### **3. Транзакции и долги**
| Таблица              | Поля и описание                                                                 |
|----------------------|---------------------------------------------------------------------------------|
| **transactions**     | `id`, `type` (приход/расход), `amount`, `date`, `description`, `from_account_id` (FK), `to_account_id` (FK), `courier_id` (FK), `status` (обработана/не обработана) |
| **debts**            | `id`, `client_id/supplier_id` (FK), `amount`, `status` (активный/погашенный)  |
| **expense_categories** | `id`, `name` (налоги, комиссии, зарплата и т.д.)                              |

---

#### **4. Балансы и логирование**
| Таблица              | Поля и описание                                                                 |
|----------------------|---------------------------------------------------------------------------------|
| **courier_balances** | `id`, `courier_id` (FK), `current_balance`, `last_update`                       |
| **logs**             | `id`, `user_id` (FK), `action` (создание/изменение), `entity_type` (транзакция/долг и т.д.), `old_value`, `new_value`, `timestamp` |

---

#### **5. Связи между таблицами**
- **1:N**:
  - `users` → `clients`, `suppliers`, `couriers` (один пользователь → одна роль).
  - `clients/suppliers` → `legal_entities` (один клиент/поставщик → много юр. лиц).
  - `legal_entities` → `bank_accounts` (одно юр. лицо → много счетов).
  - `transactions` → `legal_entities` (через `from_account_id` и `to_account_id`).
  - `transactions` → `couriers` (курьер участвует в транзакции).
  - `debts` → `clients/suppliers` (долг привязан к клиенту/поставщику).

---

#### **6. Примеры запросов**
1. **Просмотр баланса курьера**:
   ```sql
   SELECT current_balance 
   FROM courier_balances 
   WHERE courier_id = 1;
   ```

2. **Получение всех транзакций клиента**:
   ```sql
   SELECT t.* 
   FROM transactions t
   JOIN legal_entities le ON t.from_account_id = le.id
   WHERE le.client_id = 5;
   ```

3. **Расчет долга поставщика**:
   ```sql
   SELECT SUM(amount) 
   FROM debts 
   WHERE supplier_id = 3 AND status = 'active';
   ```

---

#### **7. Учет процентов**
- **Для клиентов**:
  ```sql
  UPDATE clients 
  SET percentage = 10 
  WHERE id = 1; -- 10% от суммы платежа идет системе
  ```

- **Для поставщиков**:
  ```sql
  UPDATE suppliers 
  SET percentage = 5 
  WHERE id = 2; -- 5% от суммы удерживается системой
  ```

---

#### **8. Обработка выписок**
1. **Парсинг файла**:
   - Извлекаются `account_number`, `amount`, `description`.
2. **Привязка счетов**:
   - Если `account_number` не найден в `legal_entities`, админ связывает его с клиентом/поставщиком или создает новую запись.
3. **Создание транзакции**:
   ```sql
   INSERT INTO transactions (type, amount, date, description, from_account_id, to_account_id)
   VALUES ('income', 44280, '2025-03-13', 'Возврат ошибочного платежа', 123, 456);
   ```

---

#### **9. Логирование изменений**
- **Пример записи в `logs`**:
  ```sql
  INSERT INTO logs (user_id, action, entity_type, old_value, new_value, timestamp)
  VALUES (1, 'update', 'transaction', 'status: pending', 'status: processed', NOW());
  ```

---

#### **10. Диаграмма связей**
```plaintext
users
├── clients
│   └── legal_entities
│       └── bank_accounts
├── suppliers
│   └── legal_entities
│       └── bank_accounts
├── couriers
│   └── courier_balances
└── transactions
    ├── from_account (legal_entities)
    ├── to_account (legal_entities)
    └── courier (couriers)
```
